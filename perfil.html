<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BeefMusic ‚Äì Perfil sonoro</title>

  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">

  <style>
    :root{
      --bg-main:#050509;
      --bg-secondary:#0b0c12;
      --bg-card: rgba(18,18,28,.9);
      --fg-primary:#fff;
      --fg-muted:#a5a6b3;
      --accent-pink:#ff2757;
      --accent-purple:#8a4dff;
      --border-soft: rgba(255,255,255,.08);
      --radius-lg: 32px;
      --radius-md: 20px;
      --shadow-soft: 0 20px 60px rgba(0,0,0,.6);
      --transition-fast: .25s ease;
    }

    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:"Space Grotesk",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(circle at top left,#31112f 0,#050509 45%,#050509 100%);
      color:var(--fg-primary);
      min-height:100vh;
      -webkit-font-smoothing:antialiased;
    }
    a{color:inherit;text-decoration:none}
    .page{max-width:1200px;margin:0 auto;padding:30px 24px 96px}

    /* Header */
    header{
      display:flex;align-items:center;justify-content:space-between;gap:18px;
      padding:12px 18px;border-radius:999px;
      border:1px solid var(--border-soft);
      background: linear-gradient(135deg, rgba(255,255,255,0.04), rgba(5,5,9,0.95));
      backdrop-filter: blur(20px);
      box-shadow: var(--shadow-soft);
      position: sticky; top: 16px; z-index: 20;
    }
    .logo{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;font-size:.9rem;white-space:nowrap}
    .logo-mark{
      width:32px;height:32px;border-radius:10px;overflow:hidden;
      background-image:url("img/logo.gif");
      background-size:contain;background-position:center;background-repeat:no-repeat;
      box-shadow:0 0 16px rgba(0,0,0,.6);flex-shrink:0;
    }
    .nav{display:flex;gap:18px;font-size:.85rem;color:var(--fg-muted);flex-wrap:wrap;justify-content:center}
    .nav a{position:relative;padding-bottom:2px}
    .nav a::after{
      content:"";position:absolute;left:0;bottom:-4px;width:0;height:2px;border-radius:999px;
      background: linear-gradient(90deg,var(--accent-pink),var(--accent-purple));
      transition: width var(--transition-fast);
    }
    .nav a:hover::after{width:100%}
    .nav a.active{color:var(--fg-primary)}
    .header-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    .btn{
      border-radius:999px;padding:8px 18px;font-size:.85rem;border:1px solid transparent;
      background:transparent;color:var(--fg-primary);cursor:pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), border var(--transition-fast);
      display:inline-flex;align-items:center;gap:8px;white-space:nowrap;
    }
    .btn-ghost{border-color:var(--border-soft);background:rgba(5,5,9,.7)}
    .btn-ghost:hover{transform:translateY(-1px);box-shadow:0 10px 25px rgba(0,0,0,.4)}
    .btn-primary{background:linear-gradient(135deg,var(--accent-pink),var(--accent-purple));box-shadow:0 10px 32px rgba(255,39,87,.6)}
    .btn-primary:hover{transform:translateY(-1px) scale(1.01);box-shadow:0 16px 40px rgba(255,39,87,.8)}

    /* Hero */
    .hero{
      margin-top:22px;
      padding:36px 30px;
      border-radius: var(--radius-lg);
      background:
        radial-gradient(circle at top left, rgba(255,39,87,0.26), transparent 55%),
        radial-gradient(circle at top right, rgba(138,77,255,0.28), transparent 55%),
        linear-gradient(145deg, #050509 0, #10101a 40%, #050509 100%);
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(255,255,255,0.08);
      position: relative;
      overflow: hidden;
    }
    .hero::before{
      content:"";position:absolute;inset:0;
      background-image: radial-gradient(circle at 20% 0, rgba(255,255,255,0.10) 0, transparent 52%);
      opacity: .45; pointer-events:none;
    }
    .hero-inner{
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 14px;
      width: 100%;
      max-width: none;
      align-items: stretch;
    }
    .kicker{display:inline-flex;align-items:center;gap:10px;text-transform:uppercase;letter-spacing:.25em;font-size:.7rem;color:var(--fg-muted)}
    .kdot{width:7px;height:7px;border-radius:50%;background:var(--accent-pink)}
    .hero-title{font-size: clamp(1.7rem, 3.6vw, 2.2rem); letter-spacing:.12em; text-transform:uppercase; line-height:1.05}
    .hero-sub{max-width:860px;color:var(--fg-muted);font-size:1rem;line-height:1.6}

    .hero-grid{
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 18px;
      align-items: stretch;
      width: 100%;
    }

    /* Cards */
    .card{
      border-radius: var(--radius-md);
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 16px 44px rgba(0,0,0,0.55);
      padding: 18px 18px 20px;
      position: relative;
      overflow:hidden;
    min-width:0;}
    .card::before{
      content:"";position:absolute;inset:0;
      background: radial-gradient(circle at 0 0, rgba(255,39,87,0.14), transparent 55%),
                  radial-gradient(circle at 100% 0, rgba(138,77,255,0.14), transparent 55%);
      opacity:.75; pointer-events:none;
    }
    .card > *{position:relative;z-index:1}
    .card-title{
      font-size:.75rem;text-transform:uppercase;letter-spacing:.18em;color:rgba(165,166,179,.95);
      margin-bottom: 10px;
    }

    /* Profile summary */
    .profile-top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .user-chip{
      display:flex;align-items:center;gap:10px;
      padding: 8px 10px 8px 8px;
      border-radius:999px;
      background: radial-gradient(circle at 0 0, rgba(255,39,87,0.3), transparent 55%), rgba(5,5,12,0.85);
      border:1px solid rgba(255,255,255,0.12);
      box-shadow: 0 8px 22px rgba(0,0,0,0.55);
    }
    .avatar{
      width:32px;height:32px;border-radius:999px;display:flex;align-items:center;justify-content:center;
      font-weight:700;text-transform:uppercase;color:#050509;
      background: radial-gradient(circle at 30% 20%, var(--accent-pink), var(--accent-purple));
      border: 1px solid rgba(255,255,255,0.5);
      flex-shrink:0;
    }
    .user-lines{display:flex;flex-direction:column;line-height:1.15}
    .user-label{font-size:.65rem;letter-spacing:.16em;text-transform:uppercase;color:var(--fg-muted)}
    .user-name{font-size:.95rem;font-weight:600}
    .user-title{
      margin-top:4px;
      width: fit-content;
      padding: 4px 9px;
      border-radius: 999px;
      font-size: .7rem;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: rgba(255,255,255,.92);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
    }

    .level-block{display:flex;flex-direction:column;gap:8px}
    .level-row{display:flex;align-items:baseline;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .level-main{font-size:1.1rem;font-weight:700;letter-spacing:.04em}
    .level-sub{font-size:.85rem;color:var(--fg-muted)}
    .progress{
      height:10px;border-radius:999px;background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      overflow:hidden;
    }
    .progress > span{
      display:block;height:100%;width:0%;
      background: linear-gradient(90deg, var(--accent-pink), var(--accent-purple));
      border-radius:999px;
      transition: width .35s ease;
    }

    /* Stats grid */
    .stats-grid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 14px;
    }
    .stat{
      padding: 12px 12px 14px;
      border-radius: 18px;
      background: rgba(0,0,0,0.58);
      border: 1px solid rgba(255,255,255,0.12);
      display:flex;flex-direction:column;gap:6px;
    }
    .stat .label{
      font-size:.65rem;text-transform:uppercase;letter-spacing:.16em;color:var(--fg-muted);
    }
    .stat .value{
      font-size:1.35rem;font-weight:700;
    }
    .stat .hint{
      font-size:.8rem;color:rgba(165,166,179,.92);
    }

    /* Section */
    .section{margin-top: 22px;}
    .section-header{margin-bottom: 12px;}
    .section-kicker{font-size:.75rem;text-transform:uppercase;letter-spacing:.18em;color:var(--fg-muted);margin-bottom:6px}
    .section-title{font-size:1.35rem;font-weight:600}
    .section-subtitle{margin-top:8px;font-size:.92rem;color:var(--fg-muted);max-width: 720px;line-height:1.45}

    /* Genres list */
    .genres-grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px;
    }
    .genre{
      border-radius: 18px;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 12px 12px 14px;
      box-shadow: 0 16px 44px rgba(0,0,0,0.55);
      display:flex;flex-direction:column;gap:8px;
    }
    .genre-top{display:flex;align-items:baseline;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .genre-name{font-weight:700}
    .genre-percent{font-size:.85rem;color:var(--fg-muted)}
    .genre-row{display:flex;gap:10px;flex-wrap:wrap;font-size:.85rem;color:var(--fg-muted)}
    .pill{
      padding: 6px 10px;border-radius:999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.14);
      font-size:.72rem;letter-spacing:.08em;text-transform:uppercase;
      width: fit-content;
    }

    /* Mood tags */
    .tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .tag{
      padding: 7px 12px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      font-size: .78rem;
    }

    /* Logros UI */
    .logros-toolbar{
      margin-top: 14px;
      display:flex;gap:12px;flex-wrap:wrap;align-items:center;
      border-radius: 18px;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 14px;
      box-shadow: 0 16px 44px rgba(0,0,0,0.55);
    }
    .control{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.70);
      color: var(--fg-primary);
      padding: 11px 12px;
      font: inherit;
      outline: none;
      min-height: 40px;
    }
    .control::placeholder{color: rgba(165,166,179,0.6)}
    .segmented{
      display:inline-flex;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.65);
    }
    .segmented button{
      padding: 10px 12px;
      font-size: .82rem;
      border:none;background:transparent;color:var(--fg-muted);
      cursor:pointer;
      transition: background var(--transition-fast), color var(--transition-fast);
    }
    .segmented button.active{
      color: var(--fg-primary);
      background: rgba(255,255,255,0.08);
    }

    .badges-grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 14px;
    }
    .badge-card{
      border-radius: 20px;
      background: var(--bg-card);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 20px;
      display:flex;flex-direction:column;gap:10px;
      position:relative;overflow:hidden;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), border var(--transition-fast);
    }
    .badge-card:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,0.22);
      box-shadow: 0 22px 52px rgba(0,0,0,0.72);
    }
    .badge-card::before{
      content:"";position:absolute;inset:0;
      background: radial-gradient(circle at 0 0, rgba(255,39,87,0.16), transparent 55%),
                  radial-gradient(circle at 100% 0, rgba(138,77,255,0.16), transparent 55%);
      opacity: .7; pointer-events:none;
    }
    .badge-card > *{position:relative;z-index:1}
    .badge-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .badge-icon{
      width:44px;height:44px;border-radius:16px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.14);
      font-size:1.1rem;
    }
    .badge-lock{font-size:.85rem;opacity:.85;display:none}
    .badge-title{font-weight:700;font-size:1.02rem;line-height:1.35}
    .badge-desc{color: var(--fg-muted);font-size:.9rem;line-height:1.55}
    .badge-progress{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .badge-chip{
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.14);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 0.65rem;
      width: fit-content;
    }
    .badge-card.locked{
      opacity: .45;
      filter: grayscale(1);
    }
    .badge-card.locked .badge-lock{display:inline}
    .badge-small{font-size:.78rem;color: rgba(165,166,179,0.92);}


    /* Evitar que textos largos "sobresalgan" */
    .badge-title,
    .badge-desc,
    .genre-name,
    .hero-sub,
    .tag,
    .pill,
    .user-name {
      overflow-wrap: anywhere;
      word-break: break-word;
      hyphens: auto;
    }

    /* Necesario para que el wrap funcione bien en flex */
    .user-lines,
    .badge-card,
    .genre,
    .profile-top {
      min-width: 0;
    }


    /* Defensa extra por si styles.css impone max-width a contenedores del hero */
    .hero-inner, .hero-grid{
      max-width: none !important;
    }


    /* üîß FIX ANTI-CONFLICTOS: asegura que las cards del hero se estiran (aunque styles.css tenga reglas de .card) */
    .hero{ display:block !important; }
    .hero-grid{
      justify-items: stretch;
      align-content: start;
    }
    .hero-grid > .card{
      width: 100% !important;
      max-width: none !important;
      justify-self: stretch;
    }
    .card{
      width: 100%;
      max-width: none;
    }

    /* Footer */
    footer{
      margin-top: 60px;
      font-size: 0.78rem;
      color: var(--fg-muted);
      display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;
      border-top: 1px solid rgba(255,255,255,0.08);
      padding-top: 18px;
    }
    .footer-links{display:flex;gap:14px;flex-wrap:wrap}
    .footer-links a{opacity:.8}
    .footer-links a:hover{opacity:1}

    /* Responsive */
    @media (max-width: 980px){
      .hero-grid{grid-template-columns: 1fr; }
      header{border-radius: 20px;}
      .stats-grid{grid-template-columns: repeat(2, minmax(0,1fr));}
      .genres-grid{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
    @media (max-width: 720px){
      .page{padding: 18px 16px 72px;}
      header{position: static; flex-wrap: wrap; align-items: flex-start; border-radius: 18px;}
      .nav{display:none;}
      .stats-grid{grid-template-columns: 1fr;}
      .genres-grid{grid-template-columns: 1fr;}
      .logros-toolbar{justify-content:stretch;}
      .logros-toolbar .control{flex:1; min-width: 180px;}
      .segmented{width:100%;}
      .segmented button{flex:1;}
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <a class="logo" href="index.html" aria-label="BeefMusic Home">
        <span class="logo-mark" aria-hidden="true"></span>
        <span>BeefMusic</span>
      </a>

      <nav class="nav" aria-label="Navegaci√≥n">
        <a href="index.html">Inicio</a>
        <a href="canciones.html">Canciones</a>
        <a href="peticiones.html">Peticiones</a>
        <a href="perfil.html" class="active">Perfil</a>
      </nav>

      <div class="header-actions">
        <button class="btn btn-ghost" id="logout-btn" type="button">Cerrar sesi√≥n</button>
        <a class="btn btn-primary" href="canciones.html">‚ñ∂ Ver canciones</a>
      </div>
    </header>

    <section class="hero">
      <div class="hero-inner">
        <div class="kicker"><span class="kdot"></span><span>Tu identidad sonora</span></div>
        <h1 class="hero-title">Perfil sonoro</h1>
        <p class="hero-sub">
          Tu perfil se calcula con tus likes y dislikes. Vota canciones para desbloquear logros, subir de nivel y marcar tu estilo.
        </p>

        <div class="hero-grid">
          <!-- Resumen usuario + mood -->
          <div class="card">
            <div class="profile-top">
              <div class="user-chip">
                <div class="avatar" id="avatar">U</div>
                <div class="user-lines">
                  <span class="user-label">Conectado</span>
                  <span class="user-name" id="username">@usuario</span>
                  <span class="user-title" id="user-title">‚Äî</span>
                </div>
              </div>

              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <span class="pill" id="dominant-genre">Dominante: ‚Äî</span>
                <span class="pill" id="mood-label">Mood: ‚Äî</span>
              </div>
            </div>

            <div class="tags" id="mood-tags"></div>

            <div class="stats-grid" style="margin-top:14px">
              <div class="stat">
                <div class="label">Votos</div>
                <div class="value" id="totalVotes">0</div>
                <div class="hint">Likes + dislikes</div>
              </div>
              <div class="stat">
                <div class="label">Likes</div>
                <div class="value" id="totalLikes">0</div>
                <div class="hint">Temas que te flipa</div>
              </div>
              <div class="stat">
                <div class="label">Dislikes</div>
                <div class="value" id="totalDislikes">0</div>
                <div class="hint">Ojo fino</div>
              </div>
              <div class="stat">
                <div class="label">Toxicidad</div>
                <div class="value" id="toxicity">0%</div>
                <div class="hint">Dislikes/votos</div>
              </div>
            </div>
          </div>

          <!-- Nivel / XP -->
          <div class="card">
            <div class="card-title">Nivel BeefMusic</div>
            <div class="level-block">
              <div class="level-row">
                <div>
                  <div class="level-main" id="level-line">Nivel ‚Äî</div>
                  <div class="level-sub" id="xp-line">XP ‚Äî</div>
                </div>
                <div class="pill" id="rank-pill">‚Äî</div>
              </div>
              <div class="progress" aria-label="Progreso de nivel">
                <span id="xp-bar"></span>
              </div>
              <div class="level-row" style="margin-top:2px">
                <div class="level-sub" id="xp-progress">‚Äî</div>
                <div class="level-sub" id="xp-next">‚Äî</div>
              </div>

              <div class="card-title" style="margin-top:12px">Badges r√°pidos</div>
              <div class="tags" id="quick-badges"></div>
              <div class="badge-small" style="margin-top:2px; opacity:.9" id="badges-note">
                (Estos son los badges ‚Äúresumen‚Äù. Abajo tienes la colecci√≥n de 100 logros.)
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- G√©neros -->
    <section class="section" id="generos">
      <div class="section-header">
        <div class="section-kicker">Taste</div>
        <h2 class="section-title">Tus g√©neros</h2>
        <p class="section-subtitle">
          Se calcula por tus votos. Si no hay datos suficientes, vota algunas canciones y vuelve.
        </p>
      </div>

      <div class="genres-grid" id="genres-grid"></div>
    </section>

    <!-- Logros -->
    <section class="section" id="logros">
      <div class="section-header">
        <div class="section-kicker">Colecci√≥n</div>
        <h2 class="section-title">100 logros</h2>
        <p class="section-subtitle">
          Los bloqueados salen en gris. Usa filtros y buscador para encontrarlos r√°pido.
        </p>
      </div>

      <div class="logros-toolbar">
        <input id="search" class="control" type="text" placeholder="Buscar logro‚Ä¶ (ej: Drill, votos, likes, toxicidad)" />
        <div class="segmented" role="tablist" aria-label="Filtro de logros">
          <button type="button" class="active" data-filter="all">Todos</button>
          <button type="button" data-filter="unlocked">Desbloqueados</button>
          <button type="button" data-filter="locked">Bloqueados</button>
        </div>
        <select id="sort" class="control" style="min-width:180px">
          <option value="smart">Orden inteligente</option>
          <option value="locked-first">Bloqueados primero</option>
          <option value="unlocked-first">Desbloqueados primero</option>
          <option value="progress">M√°s cerca de desbloquear</option>
          <option value="az">A ‚Üí Z</option>
        </select>
      </div>

      <div class="badges-grid" id="badges-grid"></div>
    </section>

    <footer>
      <span>¬© <span id="year"></span> BeefMusic. Todos los derechos reservados.</span>
      <div class="footer-links">
        <a href="#">T√©rminos</a>
        <a href="#">Privacidad</a>
        <a href="#">Contacto</a>
      </div>
    </footer>
  </div>

  <script>
    const API_URL = "https://beefmusic-backend.onrender.com";
    document.getElementById("year").textContent = new Date().getFullYear();

    // Auth gate
    (function () {
      const userToken = localStorage.getItem("beefmusic_user_token");
      if (!userToken) window.location.href = "user-login.html";
    })();

    // Logout
    const logoutBtn = document.getElementById("logout-btn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("beefmusic_user_token");
        localStorage.removeItem("beefmusic_user_name");
        window.location.href = "user-login.html";
      });
    }

    // Helpers
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const safeNum = (v) => (typeof v === "number" && isFinite(v)) ? v : 0;

    function getGenreVotes(profile, genreName) {
      const g = (profile.genres || []).find(x => (x.name || "").toLowerCase() === genreName.toLowerCase());
      return g ? { likes: safeNum(g.likes), dislikes: safeNum(g.dislikes), percent: safeNum(g.percent) } : { likes: 0, dislikes: 0, percent: 0 };
    }

    // ---- LEVEL MODEL (frontend fallback) ----
    function calcLevelFromXp(xp) {
      let level = 1;
      let remaining = xp;
      let cost = 20;
      while (remaining >= cost && level < 100) {
        remaining -= cost;
        level += 1;
        cost = Math.round(20 + level * 6);
      }
      return { level, xpIntoLevel: remaining, xpForNextLevel: cost };
    }

    function titleForLevel(level) {
      const table = [
        { min: 1,  title: "Beef Rookie" },
        { min: 5,  title: "Beat Hunter" },
        { min: 10, title: "Hook Crafter" },
        { min: 15, title: "Flow Engineer" },
        { min: 20, title: "Studio Menace" },
        { min: 30, title: "Mix & Mayhem" },
        { min: 40, title: "Neon Producer" },
        { min: 50, title: "Boss del Bloque" },
        { min: 65, title: "Leyenda del Server" },
        { min: 80, title: "Final Boss" },
        { min: 95, title: "BeefMusic Godmode" },
      ];
      let t = table[0].title;
      for (const row of table) if (level >= row.min) t = row.title;
      return t;
    }

    // ---- 100 LOGROS (cat√°logo fijo) ----
    function buildAchievementsCatalog() {
      const list = [];
      let id = 1;
      const push = (obj) => list.push({ ...obj, id: obj.id || ("A" + String(id++).padStart(3, "0")) });

      [1,2,3,5,8,10,12,15,18,20,25,30,35,40,45,50,60,70,80,90,100,125,150,175,200].forEach((t) => {
        push({ icon:"üó≥Ô∏è", title:`Votante ${t}+`, desc:`Alcanza ${t} votos totales.`, type:"totalVotes", target:t });
      });

      [1,2,3,5,8,10,12,15,18,20,25,30,35,40,45,50,60,70,80,90,100,120,140,160,180].forEach((t) => {
        push({ icon:"üéß", title:`Coleccionista de bangers ${t}+`, desc:`Consigue ${t} likes totales.`, type:"totalLikes", target:t });
      });

      [1,2,3,5,8,10,12,15,18,20,25,30,40,50,75].forEach((t) => {
        push({ icon:"üí£", title:`Hater con criterio ${t}+`, desc:`Da ${t} dislikes totales.`, type:"totalDislikes", target:t });
      });

      [5,10,15,20,30,40,50,60,70,80].forEach((t) => {
        push({ icon:"üòà", title:`Toxicidad ${t}%`, desc:`Alcanza ${t}% de toxicidad (dislikes/votos).`, type:"toxicity", target:t });
      });

      const genres = ["Trap","Drill","Dembow","Boom Bap","Phonk","Corridos tumbados","Afrobeat","Dancehall","R&B","Reggaet√≥n","Rap","Pop urbano"];
      const perTargets = [5, 20];
      genres.forEach((g) => {
        perTargets.forEach((t) => {
          push({ icon:"üéõÔ∏è", title:`${t} likes en ${g}`, desc:`Consigue ${t} likes en ${g}.`, type:"genreLikes", genre:g, target:t });
        });
      });

      push({ icon:"üåà", title:"Explorador de estilos", desc:"Vota en 5 g√©neros distintos.", type:"genreDiversity", target:5 });

      return list.slice(0, 100);
    }

    const ACHIEVEMENTS = buildAchievementsCatalog();

    function getProgressForAchievement(profile, a) {
      const totalVotes = safeNum(profile.totalVotes);
      const totalLikes = safeNum(profile.totalLikes);
      const totalDislikes = safeNum(profile.totalDislikes);
      const toxicity = safeNum(profile.toxicity);

      if (a.type === "totalVotes") return { current: totalVotes, target: a.target };
      if (a.type === "totalLikes") return { current: totalLikes, target: a.target };
      if (a.type === "totalDislikes") return { current: totalDislikes, target: a.target };
      if (a.type === "toxicity") return { current: toxicity, target: a.target };
      if (a.type === "genreLikes") {
        const g = getGenreVotes(profile, a.genre);
        return { current: g.likes, target: a.target };
      }
      if (a.type === "genreDiversity") {
        const distinct = (profile.genres || []).filter(g => (safeNum(g.likes) + safeNum(g.dislikes)) > 0).length;
        return { current: distinct, target: a.target };
      }
      return { current: 0, target: a.target || 1 };
    }

    function isUnlocked(progress) {
      return safeNum(progress.current) >= safeNum(progress.target);
    }

    // Render sections
    function renderProfile(profile) {
      const stored = localStorage.getItem("beefmusic_user_name");
      const uname = profile.username || stored || "usuario";
      document.getElementById("username").textContent = "@" + uname;
      document.getElementById("avatar").textContent = String(uname).charAt(0).toUpperCase();

      document.getElementById("totalVotes").textContent = safeNum(profile.totalVotes);
      document.getElementById("totalLikes").textContent = safeNum(profile.totalLikes);
      document.getElementById("totalDislikes").textContent = safeNum(profile.totalDislikes);
      document.getElementById("toxicity").textContent = safeNum(profile.toxicity) + "%";

      document.getElementById("dominant-genre").textContent = "Dominante: " + (profile.dominantGenre || "‚Äî");
      document.getElementById("mood-label").textContent = "Mood: " + (profile.moodLabel || "‚Äî");

      const tagsEl = document.getElementById("mood-tags");
      tagsEl.innerHTML = "";
      (profile.moodTags || []).slice(0, 10).forEach(t => {
        const s = document.createElement("span");
        s.className = "tag";
        s.textContent = t;
        tagsEl.appendChild(s);
      });

      const qb = document.getElementById("quick-badges");
      qb.innerHTML = "";
      (profile.badges || []).slice(0, 8).forEach(b => {
        const s = document.createElement("span");
        s.className = "tag";
        s.textContent = `${b.icon || "üè∑Ô∏è"} ${b.label || ""}`.trim();
        qb.appendChild(s);
      });
      if (!profile.badges || profile.badges.length === 0) {
        const s = document.createElement("span");
        s.className = "tag";
        s.textContent = "Vota canciones para desbloquear badges";
        qb.appendChild(s);
      }

      const xpTotal = safeNum(profile.xp);
      const backendLevel = safeNum(profile.level);
      const backendTitle = (profile.title || "").trim();

      let level = backendLevel;
      let xpIntoLevel = safeNum(profile.xpIntoLevel);
      let xpForNext = safeNum(profile.xpForNextLevel);

      if (!level) {
        const calc = calcLevelFromXp(xpTotal);
        level = calc.level;
        xpIntoLevel = calc.xpIntoLevel;
        xpForNext = calc.xpForNextLevel;
      } else {
        if (!xpForNext) {
          const calc = calcLevelFromXp(xpTotal);
          xpIntoLevel = calc.xpIntoLevel;
          xpForNext = calc.xpForNextLevel;
        }
      }

      const title = backendTitle || titleForLevel(level);
      document.getElementById("user-title").textContent = title;
      document.getElementById("level-line").textContent = `Nivel ${level}`;
      document.getElementById("xp-line").textContent = `XP total: ${xpTotal}`;
      document.getElementById("rank-pill").textContent = title;

      const pct = xpForNext > 0 ? clamp(Math.round((xpIntoLevel / xpForNext) * 100), 0, 100) : 0;
      document.getElementById("xp-bar").style.width = pct + "%";
      document.getElementById("xp-progress").textContent = `Progreso: ${xpIntoLevel}/${xpForNext} XP`;
      document.getElementById("xp-next").textContent = `Siguiente nivel: +${Math.max(0, xpForNext - xpIntoLevel)} XP`;

      renderGenres(profile);
      renderAchievements(profile);
    }

    function renderGenres(profile) {
      const grid = document.getElementById("genres-grid");
      grid.innerHTML = "";

      const genres = Array.isArray(profile.genres) ? profile.genres.slice() : [];
      if (!genres.length) {
        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `<div class="card-title">Sin datos</div><div style="color:var(--fg-muted)">Vota canciones para generar tu perfil.</div>`;
        grid.appendChild(el);
        return;
      }

      genres.sort((a,b) => safeNum(b.percent) - safeNum(a.percent));

      genres.forEach((g) => {
        const likes = safeNum(g.likes), dislikes = safeNum(g.dislikes), percent = safeNum(g.percent);
        const card = document.createElement("div");
        card.className = "genre";
        card.innerHTML = `
          <div class="genre-top">
            <div class="genre-name">${escapeHtml(g.name || "‚Äî")}</div>
            <div class="genre-percent">${percent}%</div>
          </div>
          <div class="progress" style="height:9px">
            <span style="width:${clamp(percent,0,100)}%"></span>
          </div>
          <div class="genre-row">
            <span class="pill">üëç ${likes}</span>
            <span class="pill">üëé ${dislikes}</span>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    // ---- Achievements render + filter/sort/search ----
    const badgesGrid = document.getElementById("badges-grid");
    const searchEl = document.getElementById("search");
    const sortEl = document.getElementById("sort");
    const segmented = document.querySelector(".segmented");

    let currentFilter = "all";
    let currentSearch = "";
    let currentSort = "smart";
    let lastProfile = null;

    function renderAchievements(profile) {
      lastProfile = profile;
      const items = ACHIEVEMENTS.map((a) => {
        const prog = getProgressForAchievement(profile, a);
        const unlocked = isUnlocked(prog);
        const cur = safeNum(prog.current);
        const tgt = Math.max(1, safeNum(prog.target));
        const ratio = clamp(cur / tgt, 0, 1);
        return { a, prog: { cur, tgt, ratio }, unlocked };
      });

      let filtered = items;
      if (currentFilter === "unlocked") filtered = filtered.filter(x => x.unlocked);
      if (currentFilter === "locked") filtered = filtered.filter(x => !x.unlocked);

      if (currentSearch) {
        const q = currentSearch.toLowerCase();
        filtered = filtered.filter(x => {
          const t = (x.a.title + " " + x.a.desc + " " + (x.a.genre || "")).toLowerCase();
          return t.includes(q);
        });
      }

      const sorters = {
        "smart": (x,y) => (x.unlocked === y.unlocked) ? (y.prog.ratio - x.prog.ratio) : (x.unlocked ? 1 : -1),
        "locked-first": (x,y) => (x.unlocked === y.unlocked) ? 0 : (x.unlocked ? 1 : -1),
        "unlocked-first": (x,y) => (x.unlocked === y.unlocked) ? 0 : (x.unlocked ? -1 : 1),
        "progress": (x,y) => (y.prog.ratio - x.prog.ratio),
        "az": (x,y) => x.a.title.localeCompare(y.a.title, "es", { sensitivity: "base" }),
      };
      filtered.sort(sorters[currentSort] || sorters.smart);

      badgesGrid.innerHTML = filtered.map(({ a, prog, unlocked }) => {
        const pct = Math.round(prog.ratio * 100);
        const chip = unlocked ? "Desbloqueado" : "Bloqueado";
        const progressText = `${Math.min(prog.cur, prog.tgt)}/${prog.tgt}`;
        return `
          <article class="badge-card ${unlocked ? "" : "locked"}" data-id="${escapeAttr(a.id)}">
            <div class="badge-top">
              <div class="badge-icon">${escapeHtml(a.icon || "üè∑Ô∏è")}</div>
              <div class="badge-lock">üîí</div>
            </div>
            <div class="badge-title">${escapeHtml(a.title)}</div>
            <div class="badge-desc">${escapeHtml(a.desc)}</div>
            <div class="progress" style="height:9px">
              <span style="width:${pct}%"></span>
            </div>
            <div class="badge-progress">
              <span class="badge-small">${progressText}</span>
              <span class="badge-chip">${chip}</span>
            </div>
          </article>
        `;
      }).join("");

      if (filtered.length === 0) {
        badgesGrid.innerHTML = `<div class="card"><div class="card-title">Sin resultados</div><div style="color:var(--fg-muted)">No hay logros que coincidan con tu filtro/b√∫squeda.</div></div>`;
      }
    }

    if (segmented) {
      segmented.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-filter]");
        if (!btn) return;
        currentFilter = btn.getAttribute("data-filter") || "all";
        segmented.querySelectorAll("button").forEach(b => b.classList.toggle("active", b === btn));
        if (lastProfile) renderAchievements(lastProfile);
      });
    }

    if (searchEl) {
      let t = null;
      searchEl.addEventListener("input", () => {
        currentSearch = searchEl.value.trim();
        clearTimeout(t);
        t = setTimeout(() => lastProfile && renderAchievements(lastProfile), 120);
      });
    }
    if (sortEl) {
      sortEl.addEventListener("change", () => {
        currentSort = sortEl.value;
        if (lastProfile) renderAchievements(lastProfile);
      });
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
    function escapeAttr(str) {
      return String(str ?? "").replaceAll('"', "");
    }

    async function loadProfile() {
      const token = localStorage.getItem("beefmusic_user_token");
      try {
        const res = await fetch(API_URL + "/api/sound-profile", {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        if (!res.ok || data?.error) throw new Error(data?.error || "Error obteniendo perfil");
        renderProfile(data);
      } catch (e) {
        console.error(e);
        const grid = document.getElementById("genres-grid");
        if (grid) {
          grid.innerHTML = `<div class="card"><div class="card-title">Error</div><div style="color:var(--fg-muted)">No se pudo cargar tu perfil. Vuelve a iniciar sesi√≥n o prueba m√°s tarde.</div></div>`;
        }
      }
    }

    loadProfile();
  </script>
</body>
</html>
