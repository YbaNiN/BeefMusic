<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BeefMusic ‚Äì Perfil sonoro</title>

    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tu CSS global -->
    <link rel="stylesheet" href="styles.css" />

    <style>
        body {
            font-family: "Space Grotesk", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: radial-gradient(circle at top, #160b33 0, #050509 45%, #020105 100%);
            color: #f5f5ff;
            min-height: 100vh;
        }

        .sound-profile-page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 20px 80px;
        }

        /* HEADER LOCAL */
        .site-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .site-logo {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .site-logo-img {
            height: 40px;
            width: auto;
            display: block;
            border-radius: 10px;
            box-shadow: 0 0 18px rgba(236, 72, 153, 0.4);
        }

        .site-nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            font-size: 0.85rem;
            opacity: 0.85;
        }

            .site-nav a {
                text-decoration: none;
                color: inherit;
                padding: 6px 10px;
                border-radius: 999px;
                border: 1px solid transparent;
                transition: background 0.2s ease, border-color 0.2s ease, opacity 0.2s ease;
            }

                .site-nav a:hover {
                    opacity: 1;
                    border-color: rgba(255, 255, 255, 0.18);
                    background: rgba(0, 0, 0, 0.35);
                }

                .site-nav a.active {
                    border-color: rgba(255, 255, 255, 0.22);
                    background: radial-gradient(circle at top left, rgba(139, 92, 246, 0.45), rgba(15, 23, 42, 0.9));
                }

        /* CONTENEDOR HEADER PERFIL (CARD GRANDE, CUADRADA) */
        .sound-profile-header-card {
            margin: 24px 0 30px;
            padding: 24px 28px 22px;
            border-radius: 0; /* cuadrado total */
            border: 1px solid rgba(148, 163, 184, 0.25);
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.95)), linear-gradient(120deg, rgba(79, 70, 229, 0.20), rgba(236, 72, 153, 0.10));
            box-shadow: 0 22px 55px rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            gap: 18px; /* espacio entre t√≠tulo+texto y las pills */
        }

        @media (max-width: 640px) {
            .sound-profile-header-card {
                padding: 20px 18px 18px;
                margin: 20px 0 24px;
            }
        }

        /* HEADER PERFIL SONORO (dentro de la card) */
        .sound-profile-header {
            position: relative;
            margin: 24px 0 20px; /* separa la card del resto */
            padding: 18px 24px 20px; /* aire por dentro: arriba, lados y abajo */
            border-radius: 0; /* CUADRADO */
            background: rgba(15, 23, 42, 0.96);
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
            overflow: hidden;
        }

            /* anulamos cualquier pseudo-elemento raro del estilo antiguo */
            .sound-profile-header::before,
            .sound-profile-header::after {
                content: none !important;
            }

        .sound-profile-header-main {
            display: flex;
            flex-direction: column;
            gap: 10px; /* espacio entre t√≠tulo, tagline y estado */
        }

        .sound-profile-title-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 14px; /* espacio entre "Perfil sonoro" y @usuario */
            margin-bottom: 4px;
        }

        .sound-profile-header-main h1 {
            font-size: 1.9rem;
            margin: 0;
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }

        .sound-profile-username {
            font-size: 0.98rem;
            opacity: 0.85;
        }

        .sound-profile-tagline {
            font-size: 0.93rem;
            margin: 0;
            margin-top: 2px;
            line-height: 1.7; /* l√≠neas m√°s separadas */
            color: #c7d2fe;
            max-width: 680px; /* evita l√≠neas muy largas */
        }

        /* En m√≥vil, el @usuario baja debajo del t√≠tulo para que no se aplaste */
        @media (max-width: 640px) {
            .sound-profile-title-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
        }

        /* ESTADO (texto peque√±o bajo la tagline) */
        .profile-status {
            font-size: 0.85rem;
            opacity: 0.85;
            margin-top: 6px; /* separaci√≥n clara con la tagline */
        }

            .profile-status.error {
                color: #fecaca;
            }

            .profile-status.info {
                color: #bfdbfe;
            }

        /* PILLS DE ESTADO (MODO / ACTIVIDAD) */
        .sound-profile-status-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 0; /* ya tenemos gap en la card */
        }

        .sound-profile-pill {
            padding: 8px 16px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(120deg, rgba(147, 51, 234, 0.18), rgba(244, 63, 94, 0.22));
            backdrop-filter: blur(10px);
            box-shadow: 0 14px 30px rgba(0, 0, 0, 0.7);
            max-width: 100%;
        }

            .sound-profile-pill span {
                font-size: 0.9rem;
            }

        @media (max-width: 600px) {
            .sound-profile-status-row {
                flex-direction: row;
                flex-wrap: wrap;
                align-items: flex-start;
            }

                .sound-profile-status-row .sound-profile-pill {
                    justify-content: flex-start;
                }
        }

        /* GRID PRINCIPAL */
        .sound-profile-main {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
            gap: 20px;
            align-items: flex-start;
        }

        @media (max-width: 900px) {
            .sound-profile-main {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .card {
            background: radial-gradient(circle at top left, rgba(168, 85, 247, 0.18), transparent 55%);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            padding: 18px 18px 16px;
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.78);
            position: relative;
            overflow: hidden;
        }

            .card::before {
                content: "";
                position: absolute;
                inset: 0;
                background: radial-gradient(circle at top right, rgba(244, 63, 94, 0.12), transparent 55%);
                opacity: 0.9;
                pointer-events: none;
            }

        .card-inner {
            position: relative;
            z-index: 1;
        }

        .card-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            opacity: 0.7;
            margin-bottom: 12px;
        }

        /* DISTRIBUCI√ìN DE G√âNEROS */
        .genres-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .genre-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .genre-row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .genre-name {
            opacity: 0.9;
        }

        .genre-percent {
            opacity: 0.7;
            font-variant-numeric: tabular-nums;
        }

        .genre-bar {
            position: relative;
            height: 7px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            overflow: hidden;
            box-shadow: inset 0 0 6px rgba(15, 23, 42, 0.9);
        }

        .genre-bar-fill {
            position: absolute;
            inset: 0;
            transform-origin: left center;
            transform: scaleX(0);
            background-image: linear-gradient(90deg, #a855f7, #ec4899, #f97316);
        }

        /* MOOD + TOXICIDAD */
        .mood-grid {
            display: grid;
            grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
            gap: 16px;
        }

        @media (max-width: 600px) {
            .mood-grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .mood-main-label {
            font-size: 1.1rem;
            margin: 0 0 2px;
        }

        .mood-sub {
            font-size: 0.86rem;
            opacity: 0.75;
            margin-bottom: 10px;
        }

        .mood-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
        }

        .mood-tag {
            font-size: 0.75rem;
            border-radius: 999px;
            padding: 4px 9px;
            border: 1px solid rgba(255, 255, 255, 0.14);
            background: rgba(0, 0, 0, 0.26);
        }

        .toxicity-wrapper {
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: flex-start;
        }

        .toxicity-score {
            font-size: 1.4rem;
            font-variant-numeric: tabular-nums;
        }

        .toxicity-label {
            font-size: 0.8rem;
            opacity: 0.75;
        }

        .toxicity-bar {
            width: 100%;
            height: 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 0 6px rgba(15, 23, 42, 0.9);
        }

        .toxicity-fill {
            position: absolute;
            inset: 0;
            transform-origin: left;
            transform: scaleX(0);
            background-image: linear-gradient(90deg, #22c55e, #eab308, #f97316, #ef4444);
        }

        .toxicity-note {
            font-size: 0.78rem;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* BADGES */
        .badges-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.78rem;
            padding: 5px 9px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(10, 10, 18, 0.8);
            backdrop-filter: blur(10px);
            white-space: nowrap;
        }

        .badge-icon {
            font-size: 0.9rem;
        }

        .sound-profile-footer {
            margin-top: 20px;
            font-size: 0.8rem;
            opacity: 0.7;
        }

            .sound-profile-footer strong {
                font-weight: 500;
            }

        /* ========== LOGROS (COLECCI√ìN) ========== */
        .achievements-wrap {
            margin-top: 22px;
        }

        .achievements-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .achievements-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            opacity: 0.7;
        }

        .achievements-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .achievements-chip {
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.14);
            background: rgba(0, 0, 0, 0.28);
            cursor: pointer;
            color: inherit;
            transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease;
            user-select: none;
        }

        .achievements-chip:hover {
            transform: translateY(-1px);
            border-color: rgba(255, 255, 255, 0.24);
            background: rgba(0, 0, 0, 0.38);
        }

        .achievements-chip.active {
            border-color: rgba(255, 255, 255, 0.22);
            background: radial-gradient(circle at top left, rgba(139, 92, 246, 0.35), rgba(15, 23, 42, 0.75));
        }

        .achievements-search {
            border-radius: 999px;
            padding: 7px 12px;
            font-size: 0.78rem;
            border: 1px solid rgba(255,255,255,0.16);
            background: rgba(0,0,0,0.45);
            color: inherit;
            min-width: 220px;
        }

        .achievements-search:focus {
            outline: none;
            border-color: rgba(255,255,255,0.26);
            box-shadow: 0 0 0 2px rgba(168,85,247,0.12);
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 14px;
        }

        .achievement-card {
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(10, 10, 18, 0.72);
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.65);
            padding: 14px 14px 14px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .achievement-card::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 0 0, rgba(168, 85, 247, 0.16), transparent 55%),
                        radial-gradient(circle at 100% 0, rgba(236, 72, 153, 0.14), transparent 55%);
            opacity: 0.9;
            pointer-events: none;
        }

        .achievement-top {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .achievement-icon {
            width: 38px;
            height: 38px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.15rem;
            background: rgba(0,0,0,0.45);
            border: 1px solid rgba(255,255,255,0.14);
        }

        .achievement-lock {
            font-size: 0.9rem;
            opacity: 0.8;
            display: none;
        }

        .achievement-name {
            position: relative;
            z-index: 1;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .achievement-desc {
            position: relative;
            z-index: 1;
            font-size: 0.82rem;
            opacity: 0.78;
            line-height: 1.35;
        }

        .achievement-bottom {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .achievement-progress {
            font-size: 0.78rem;
            opacity: 0.75;
            font-variant-numeric: tabular-nums;
        }

        .achievement-state {
            padding: 5px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.14);
            background: rgba(255,255,255,0.06);
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-size: 0.65rem;
            white-space: nowrap;
        }

        .achievement-bar {
            position: relative;
            z-index: 1;
            height: 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            overflow: hidden;
            box-shadow: inset 0 0 6px rgba(15, 23, 42, 0.9);
        }

        .achievement-bar-fill {
            position: absolute;
            inset: 0;
            transform-origin: left;
            transform: scaleX(0);
            background-image: linear-gradient(90deg, #a855f7, #ec4899, #f97316);
        }

        .achievement-card.locked {
            opacity: 0.45;
            filter: grayscale(1);
        }

        .achievement-card.locked .achievement-lock {
            display: inline;
        }

        @media (max-width: 520px) {
            .achievements-search {
                min-width: 100%;
            }
        }

    </style>

</head>
<body>
    <main class="sound-profile-page">
        <header class="site-header">
            <!-- LOGO BEEFMUSIC (GIF) -->
            <a href="index.html" class="site-logo">
                <img src="img/logo.gif" alt="BeefMusic" class="site-logo-img">
            </a>

            <nav class="site-nav">
                <a href="index.html">Inicio</a>
                <a href="canciones.html">Canciones</a>
                <a href="perfil.html" class="active">Perfil sonoro</a>
            </nav>
        </header>

        <!-- CARD CUADRADA DEL PERFIL SONORO -->
        <section class="sound-profile-header-card">
            <header class="sound-profile-header">
                <div class="sound-profile-header-main">
                    <div class="sound-profile-title-row">
                        <h1>Perfil sonoro</h1>
                        <span class="sound-profile-username">@usuario</span>
                    </div>

                    <p class="sound-profile-tagline">
                        Cargando tu perfil sonoro‚Ä¶
                    </p>
                    <div id="profile-status" class="profile-status info"></div>
                </div>
            </header>

            <div class="sound-profile-status-row">
                <div class="sound-profile-pill">
                    <span>üéß Modo actual:</span>
                    <strong id="pill-mode">Analizando tus gustos‚Ä¶</strong>
                </div>
                <div class="sound-profile-pill">
                    <span>‚è± √öltima actividad:</span>
                    <strong id="pill-activity">‚Äì</strong>
                </div>
            </div>
        </section>

        <section class="sound-profile-main">
            <!-- DISTRIBUCI√ìN DE G√âNEROS -->
            <article class="card">
                <div class="card-inner">
                    <div class="card-title">Distribuci√≥n de g√©neros</div>
                    <div class="genres-list" id="genres-list">
                        <!-- Se rellena con JS -->
                    </div>
                </div>
            </article>

            <!-- MOOD + TOXICIDAD + BADGES -->
            <article class="card">
                <div class="card-inner">
                    <div class="card-title">Mood & actitud</div>
                    <div class="mood-grid">
                        <div>
                            <p class="mood-main-label">
                                Mood predominante: <strong id="mood-label">Cargando‚Ä¶</strong>
                            </p>
                            <p class="mood-sub" id="mood-sub">
                                Analizando tus likes y dislikes para adivinar qu√© clase de ente musical eres.
                            </p>

                            <div class="mood-tags" id="mood-tags">
                                <!-- Tags generados por JS -->
                            </div>
                        </div>

                        <div class="toxicity-wrapper">
                            <div>
                                <div class="toxicity-score" id="toxicity-score">0%</div>
                                <div class="toxicity-label">Nivel de toxicidad musical</div>
                            </div>
                            <div class="toxicity-bar">
                                <div class="toxicity-fill" id="toxicity-fill"></div>
                            </div>
                            <p class="toxicity-note">
                                Cuanto m√°s alto, m√°s extremos son tus gustos. No es malo‚Ä¶ pero cuidado con lo que recomiendas üòà
                            </p>
                        </div>
                    </div>

                    <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.08); margin: 16px 0 14px;">

                    <div class="card-title" style="margin-bottom: 8px;">Badges desbloqueados</div>
                    <div class="badges-list" id="badges-list">
                        <!-- Badges generados por JS -->
                    </div>
                </div>
            </article>
        </section>


        <section class="achievements-wrap">
            <article class="card">
                <div class="card-inner">
                    <div class="achievements-header">
                        <div>
                            <div class="achievements-title">Colecci√≥n de logros</div>
                            <div style="font-size:0.85rem; opacity:0.75; margin-top:6px;">
                                100 logros para desbloquear. Los bloqueados se ven en gris.
                            </div>
                        </div>

                        <div class="achievements-controls">
                            <button class="achievements-chip active" type="button" data-filter="all">Todos</button>
                            <button class="achievements-chip" type="button" data-filter="unlocked">Desbloqueados</button>
                            <button class="achievements-chip" type="button" data-filter="locked">Bloqueados</button>
                            <input class="achievements-search" id="achievements-search" type="search" placeholder="Buscar logro‚Ä¶" />
                        </div>
                    </div>

                    <div class="achievements-grid" id="achievements-grid">
                        <!-- Logros generados por JS -->
                    </div>

                    <div style="margin-top:12px; font-size:0.78rem; opacity:0.7;">
                        Tip: vota en <strong>Canciones</strong> para subir tu progreso.
                    </div>
                </div>
            </article>
        </section>

    </main>
    <script>
        // Detecta si est√°s en local o en producci√≥n (Render) y ajusta la URL
        const API_URL =
            window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
                ? "http://localhost:4000"
                : "https://beefmusic-backend.onrender.com";

        // Inicializar p√°gina: comprobar sesi√≥n, poner nombre y cargar perfil
        (function initPerfilSonoro() {
            const token = localStorage.getItem("beefmusic_user_token");
            const storedUserName = localStorage.getItem("beefmusic_user_name");
            const usernameEl = document.querySelector(".sound-profile-username");
            const statusEl = document.getElementById("profile-status");

            if (storedUserName && usernameEl) {
                usernameEl.textContent = "@" + storedUserName;
            }

            if (!token) {
                if (statusEl) {
                    statusEl.textContent = "Inicia sesi√≥n para generar tu perfil sonoro.";
                    statusEl.classList.add("error");
                }
                setTimeout(() => {
                    window.location.href = "user-login.html";
                }, 1200);
                return;
            }

            // Si hay token, cargamos el perfil
            cargarPerfilSonoro(token);
        })();

        async function cargarPerfilSonoro(token) {
            const statusEl = document.getElementById("profile-status");

            if (statusEl) {
                statusEl.textContent = "Analizando tu actividad en BeefMusic‚Ä¶";
                statusEl.classList.remove("error");
                statusEl.classList.add("info");
            }

            try {
                const res = await fetch(API_URL + "/api/sound-profile", {
                    headers: {
                        "Authorization": "Bearer " + token
                    }
                });

                if (!res.ok) {
                    console.error("Error al obtener perfil sonoro:", res.status);

                    if (res.status === 401) {
                        if (statusEl) {
                            statusEl.textContent = "Sesi√≥n caducada. Vuelve a iniciar sesi√≥n.";
                            statusEl.classList.remove("info");
                            statusEl.classList.add("error");
                        }
                        setTimeout(() => {
                            window.location.href = "user-login.html";
                        }, 1200);
                        return;
                    }

                    if (statusEl) {
                        statusEl.textContent = "No se ha podido cargar tu perfil sonoro.";
                        statusEl.classList.remove("info");
                        statusEl.classList.add("error");
                    }
                    return;
                }

                const profile = await res.json();
                console.log("Perfil sonoro:", profile);
                pintarPerfilSonoro(profile);
                renderAchievements(profile);

                if (statusEl) {
                    if ((profile.totalVotes || 0) === 0) {
                        statusEl.textContent = "Todav√≠a no has votado ninguna canci√≥n. Empieza a dar like / no like para ver tu perfil.";
                    } else {
                        statusEl.textContent = `Perfil generado a partir de ${profile.totalVotes} votos.`;
                    }
                    statusEl.classList.remove("error");
                    statusEl.classList.add("info");
                }
            } catch (err) {
                console.error("Error de red al obtener perfil sonoro:", err);
                if (statusEl) {
                    statusEl.textContent = "Error de conexi√≥n al cargar el perfil sonoro.";
                    statusEl.classList.remove("info");
                    statusEl.classList.add("error");
                }
            }
        }

        function pintarPerfilSonoro(userSoundProfile) {
            // Username
            const usernameEl = document.querySelector(".sound-profile-username");
            if (usernameEl && userSoundProfile.username) {
                usernameEl.textContent = "@" + userSoundProfile.username;
            }

            // Tagline
            const taglineEl = document.querySelector(".sound-profile-tagline");
            if (taglineEl) {
                if (userSoundProfile.genres && userSoundProfile.genres.length > 0) {
                    const partes = userSoundProfile.genres.map(g => `${g.percent}% ${g.name}`);
                    taglineEl.innerHTML =
                        `Eres <strong>${partes.join("</strong>, <strong>")}</strong>. ` +
                        `Nivel de toxicidad musical: <strong id="toxicity-text">${userSoundProfile.toxicity}%</strong> üî•`;
                } else {
                    taglineEl.textContent =
                        "A√∫n no tenemos datos suficientes. Empieza a votar canciones para generar tu perfil sonoro.";
                }
            }

            // Pill "modo actual"
            const pillMode = document.getElementById("pill-mode");
            if (pillMode) {
                if (userSoundProfile.moodLabel && userSoundProfile.moodLabel !== "A√∫n sin datos suficientes") {
                    pillMode.textContent = `"${userSoundProfile.moodLabel}"`;
                } else {
                    pillMode.textContent = "Esperando tus primeros votos";
                }
            }

            // Pill "√∫ltima actividad"
            const pillActivity = document.getElementById("pill-activity");
            if (pillActivity) {
                if ((userSoundProfile.totalVotes || 0) > 0) {
                    pillActivity.textContent = "hace poco (basado en tus votos)";
                } else {
                    pillActivity.textContent = "sin actividad reciente";
                }
            }

            // Toxicidad
            const toxicityScoreEl = document.getElementById("toxicity-score");
            const toxicityFillEl = document.getElementById("toxicity-fill");
            const toxicityTextInline = document.getElementById("toxicity-text");

            if (toxicityScoreEl && toxicityFillEl) {
                const t = userSoundProfile.toxicity ?? 0;
                toxicityScoreEl.textContent = t + "%";
                if (toxicityTextInline) toxicityTextInline.textContent = t + "%";

                requestAnimationFrame(() => {
                    toxicityFillEl.style.transition = "transform 0.8s ease-out";
                    toxicityFillEl.style.transform = "scaleX(" + (t / 100) + ")";
                });
            }

            // Mood label
            const moodLabelEl = document.getElementById("mood-label");
            if (moodLabelEl && userSoundProfile.moodLabel) {
                moodLabelEl.textContent = userSoundProfile.moodLabel;
            }

            // Mood subt√≠tulo
            const moodSubEl = document.getElementById("mood-sub");
            if (moodSubEl) {
                if ((userSoundProfile.totalVotes || 0) === 0) {
                    moodSubEl.textContent =
                        "Empieza a votar canciones para que podamos descifrar tu personalidad sonora.";
                } else if (userSoundProfile.dominantGenre) {
                    moodSubEl.innerHTML =
                        `Tu actividad reciente nos dice que vives en el terreno del <strong>${userSoundProfile.dominantGenre}</strong>.`;
                }
            }

            // G√©neros (barras)
            const genresListEl = document.getElementById("genres-list");
            if (genresListEl) {
                genresListEl.innerHTML = "";
                (userSoundProfile.genres || []).forEach(genre => {
                    const row = document.createElement("div");
                    row.className = "genre-row";

                    row.innerHTML = `
                            <div class="genre-row-header">
                                <span class="genre-name">${genre.name}</span>
                                <span class="genre-percent">${genre.percent}%</span>
                            </div>
                            <div class="genre-bar">
                                <div class="genre-bar-fill"></div>
                            </div>
                        `;

                    genresListEl.appendChild(row);

                    const fill = row.querySelector(".genre-bar-fill");
                    requestAnimationFrame(() => {
                        fill.style.transition = "transform 0.8s ease-out";
                        fill.style.transform = "scaleX(" + (genre.percent / 100) + ")";
                    });
                });

                if ((userSoundProfile.genres || []).length === 0) {
                    const empty = document.createElement("p");
                    empty.style.fontSize = "0.82rem";
                    empty.style.opacity = "0.75";
                    empty.textContent = "Sin votos a√∫n. Cuando empieces a votar canciones, ver√°s aqu√≠ qu√© g√©neros dominas.";
                    genresListEl.appendChild(empty);
                }
            }

            // Mood tags
            const moodTagsEl = document.getElementById("mood-tags");
            if (moodTagsEl) {
                moodTagsEl.innerHTML = "";
                (userSoundProfile.moodTags || []).forEach(tag => {
                    const span = document.createElement("span");
                    span.className = "mood-tag";
                    span.textContent = tag;
                    moodTagsEl.appendChild(span);
                });

                if ((userSoundProfile.moodTags || []).length === 0) {
                    const span = document.createElement("span");
                    span.className = "mood-tag";
                    span.textContent = "A√∫n sin mood definido";
                    moodTagsEl.appendChild(span);
                }
            }

            // Badges
            const badgesListEl = document.getElementById("badges-list");
            if (badgesListEl) {
                badgesListEl.innerHTML = "";
                if (!userSoundProfile.badges || userSoundProfile.badges.length === 0) {
                    const div = document.createElement("div");
                    div.className = "badge";
                    div.innerHTML = `
                            <span class="badge-icon">‚ú®</span>
                            <span>A√∫n sin logros. Todo por desbloquear.</span>
                        `;
                    badgesListEl.appendChild(div);
                } else {
                    userSoundProfile.badges.forEach(badge => {
                        const div = document.createElement("div");
                        div.className = "badge";
                        div.innerHTML = `
                                <span class="badge-icon">${badge.icon}</span>
                                <span>${badge.label}</span>
                            `;
                        badgesListEl.appendChild(div);
                    });
                }
            }
        }
    
        // =========================
        // LOGROS (100) ‚Äì COLECCI√ìN
        // =========================

        // Estado de filtros/b√∫squeda
        let achievementsFilter = "all"; // all | unlocked | locked
        let achievementsQuery = "";

        function norm(str) {
            return (str || "").toString().trim().toLowerCase();
        }

        function getGenreStat(profile, genreName) {
            const g = (profile.genres || []).find(x => norm(x.name) === norm(genreName));
            return {
                likes: g ? (g.likes || 0) : 0,
                dislikes: g ? (g.dislikes || 0) : 0
            };
        }

        function makeMilestones(prefix, icon, titleFn, descFn, currentFn, thresholds) {
            return thresholds.map((t, idx) => ({
                id: `${prefix}_${t}_${idx}`,
                icon,
                title: titleFn(t),
                desc: descFn(t),
                current: currentFn,
                target: t
            }));
        }

        function buildAchievementsCatalog(profile) {
            // 1) Votos (25)
            const voteThresholds = [1,2,3,4,5,6,7,8,9,10,12,14,16,18,20,22,25,30,35,40,50,60];
            const votes = makeMilestones(
                "votes",
                "üó≥Ô∏è",
                (t) => `Votante ${t}`,
                (t) => `Acumula ${t} votos en canciones.`,
                (p) => p.totalVotes || 0,
                voteThresholds
            );

            // 2) Likes (25)
            const likeThresholds = [1,2,3,4,5,6,7,8,9,10,12,14,16,18,20,22,25,30,35,40,50,60,75,90,100];
            const likes = makeMilestones(
                "likes",
                "üëç",
                (t) => `Buen o√≠do x${t}`,
                (t) => `Dale ${t} likes en total.`,
                (p) => p.totalLikes || 0,
                likeThresholds
            );

            // 3) Dislikes (15)
            const dislikeThresholds = [1,2,3,4,5,7,10,12,15,18,20,25,30];
            const dislikes = makeMilestones(
                "dislikes",
                "üëé",
                (t) => `Cr√≠tico x${t}`,
                (t) => `Dale ${t} dislikes en total.`,
                (p) => p.totalDislikes || 0,
                dislikeThresholds
            );

            // 3.5) Cambios de voto / quitar voto (5)
            // Requiere que el backend env√≠e voteSwitches y voteRemovals en /api/sound-profile
            const switchThresholds = [1,2,5];
            const voteSwitches = makeMilestones(
                "vote_switches",
                "üîÅ",
                (t) => (t === 1 ? "Cambio de opini√≥n" : `Cambiaste voto x${t}`),
                (t) => (t === 1 ? "Cambia tu voto por primera vez." : `Cambia tu voto ${t} veces.`),
                (p) => p.voteSwitches || 0,
                switchThresholds
            );

            const removalThresholds = [1,5];
            const voteRemovals = makeMilestones(
                "vote_removals",
                "üßΩ",
                (t) => (t === 1 ? "Voto retirado" : `Retiradas x${t}`),
                (t) => (t === 1 ? "Quita tu voto por primera vez." : `Quita tu voto ${t} veces.`),
                (p) => p.voteRemovals || 0,
                removalThresholds
            );

            // 4) Toxicidad (10)
            // Aqu√≠ el progreso se mide por porcentaje, target = umbral
            const toxicityThresholds = [5,10,15,20,30,40,50,60,70,80];
            const toxicity = makeMilestones(
                "toxicity",
                "üòà",
                (t) => `Toxicidad ${t}%`,
                (t) => `Alcanza un ${t}% de toxicidad musical (dislikes/votos).`,
                (p) => p.toxicity || 0,
                toxicityThresholds
            );

            // 5) Likes por g√©nero (24) ‚Äì 12 g√©neros * (5 y 20 likes)
            const GENRES = [
                "Trap",
                "Drill",
                "Dembow",
                "Reggaet√≥n",
                "Rap",
                "Boom Bap",
                "Afrobeat",
                "R&B",
                "Phonk",
                "Corridos tumbados",
                "Club / EDM",
                "Pop urbano"
            ];

            const genre5 = GENRES.map((g) => ({
                id: "genre5_" + norm(g).replace(/\s+/g, "_"),
                icon: "üéöÔ∏è",
                title: `Fan de ${g}`,
                desc: `Consigue 5 likes en el estilo ${g}.`,
                current: (p) => getGenreStat(p, g).likes,
                target: 5
            }));

            const genre20 = GENRES.map((g) => ({
                id: "genre20_" + norm(g).replace(/\s+/g, "_"),
                icon: "üèÜ",
                title: `Leyenda ${g}`,
                desc: `Consigue 20 likes en el estilo ${g}.`,
                current: (p) => getGenreStat(p, g).likes,
                target: 20
            }));

            // 6) Diversidad (1) ‚Äì votar en 5 g√©neros distintos
            const diversity = [{
                id: "diversity_5",
                icon: "üß¨",
                title: "Paladar amplio",
                desc: "Vota en 5 g√©neros distintos (cuenta cualquier voto, like o dislike).",
                current: (p) => (p.genres || []).length,
                target: 5
            }];

            // Total: 22 + 25 + 13 + 5 + 10 + 24 + 1 = 100
            return [
                ...votes,
                ...likes,
                ...dislikes,
                ...voteSwitches,
                ...voteRemovals,
                ...toxicity,
                ...genre5,
                ...genre20,
                ...diversity
            ];
        }

        function renderAchievements(profile) {
            const grid = document.getElementById("achievements-grid");
            if (!grid) return;

            const chips = Array.from(document.querySelectorAll(".achievements-chip"));
            const search = document.getElementById("achievements-search");

            // Bind una sola vez
            if (!renderAchievements._bound) {
                chips.forEach((c) => {
                    c.addEventListener("click", () => {
                        chips.forEach(x => x.classList.remove("active"));
                        c.classList.add("active");
                        achievementsFilter = c.getAttribute("data-filter") || "all";
                        // re-render
                        renderAchievements(profile);
                    });
                });

                if (search) {
                    search.addEventListener("input", (e) => {
                        achievementsQuery = (e.target.value || "").trim().toLowerCase();
                        renderAchievements(profile);
                    });
                }

                renderAchievements._bound = true;
            }

            const catalog = buildAchievementsCatalog(profile);

            // Filtrar
            let list = catalog.map((a) => {
                const cur = Math.max(0, Number(a.current(profile) || 0));
                const tgt = Math.max(1, Number(a.target || 1));
                const unlocked = cur >= tgt;

                // progreso 0..1
                const pct = Math.max(0, Math.min(1, cur / tgt));

                return { ...a, cur, tgt, unlocked, pct };
            });

            if (achievementsFilter === "unlocked") list = list.filter(x => x.unlocked);
            if (achievementsFilter === "locked") list = list.filter(x => !x.unlocked);

            if (achievementsQuery) {
                list = list.filter(x =>
                    x.title.toLowerCase().includes(achievementsQuery) ||
                    x.desc.toLowerCase().includes(achievementsQuery)
                );
            }

            // Orden: primero desbloqueados, luego por progreso descendente, luego por target
            list.sort((a,b) => {
                if (a.unlocked !== b.unlocked) return a.unlocked ? -1 : 1;
                if (b.pct !== a.pct) return b.pct - a.pct;
                return a.tgt - b.tgt;
            });

            if (list.length === 0) {
                grid.innerHTML = `
                    <div style="opacity:0.75; font-size:0.86rem;">
                        No hay resultados con ese filtro/b√∫squeda.
                    </div>
                `;
                return;
            }

            grid.innerHTML = list.map((a) => {
                const state = a.unlocked ? "Desbloqueado" : "Bloqueado";
                const progressText = `${Math.min(a.cur, a.tgt)}/${a.tgt}`;

                return `
                    <article class="achievement-card ${a.unlocked ? "" : "locked"}">
                        <div class="achievement-top">
                            <div class="achievement-icon">${a.icon}</div>
                            <div class="achievement-lock">üîí</div>
                        </div>

                        <div class="achievement-name">${a.title}</div>
                        <div class="achievement-desc">${a.desc}</div>

                        <div class="achievement-bar" aria-hidden="true">
                            <div class="achievement-bar-fill" style="transform: scaleX(${a.pct});"></div>
                        </div>

                        <div class="achievement-bottom">
                            <div class="achievement-progress">${progressText}</div>
                            <div class="achievement-state">${state}</div>
                        </div>
                    </article>
                `;
            }).join("");
        }

    </script>
</body>
</html>
