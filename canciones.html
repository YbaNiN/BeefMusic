<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BeefMusic ‚Äî Canciones</title>

  <link rel="stylesheet" href="styles.css" />

  <style>
    /* ===== Est√©tica base (manteniendo tu look) ===== */
    :root{
      --accent-pink: #ff2aa6;
      --accent-purple:#7a2cff;
      --glass: rgba(0,0,0,0.42);
      --glass-border: rgba(255,255,255,0.12);
      --muted: rgba(255,255,255,0.65);
    }
    body{
      margin:0;
      color: rgba(255,255,255,0.92);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(122,44,255,0.25), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(255,42,166,0.18), transparent 55%),
        radial-gradient(900px 500px at 60% 110%, rgba(0,240,255,0.10), transparent 60%),
        #060608;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    .songs-page{ max-width: 1120px; margin:0 auto; padding: 22px 18px 120px; }
    .site-header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding: 12px 0 18px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.35);
      padding: 8px 12px;
      border-radius: 999px;
      text-decoration:none;
      color: inherit;
      font-size: .92rem;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .songs-hero{
      border: 1px solid var(--glass-border);
      background: var(--glass);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.35);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .songs-hero-top{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      flex-wrap: wrap;
    }
    .section-kicker{ font-size:.85rem; color: var(--muted); letter-spacing:.12em; text-transform: uppercase; }
    .section-title{ margin: 6px 0 0; font-size: 1.55rem; }
    .songs-sub{ margin-top:8px; color: var(--muted); }

    .songs-tools{
      margin-top: 12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      flex-wrap: wrap;
    }
    .songs-search{
      flex:1;
      min-width: 260px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.75);
      color: rgba(255,255,255,0.92);
      padding: 10px 12px;
      font: inherit;
    }
    .songs-count{ color: var(--muted); font-size:.9rem; }

    .songs-pills{ display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
    .songs-filter-btn{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.9);
      padding: 8px 10px;
      border-radius: 999px;
      cursor:pointer;
      font: inherit;
      font-size: .86rem;
    }
    .songs-filter-btn.active{
      border-color: rgba(255,42,166,0.45);
      box-shadow: 0 0 0 1px rgba(122,44,255,0.25) inset;
    }

    /* ===== Grid + Tarjetas (tu est√©tica) ===== */
    .songs-grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 980px){ .songs-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 640px){ .songs-grid{ grid-template-columns: 1fr; } }

    .song-card{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.42);
      border-radius: 18px;
      overflow:hidden;
      min-width:0;
      box-shadow: 0 18px 60px rgba(0,0,0,0.35);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .song-thumb{
      height: 90px;
      position: relative;
      background: radial-gradient(600px 140px at 20% 0%, rgba(122,44,255,0.55), transparent 60%),
                  radial-gradient(600px 140px at 80% 0%, rgba(255,42,166,0.45), transparent 60%),
                  rgba(0,0,0,0.25);
    }
    .song-wave{
      position:absolute; inset:auto -20% 0 -20%;
      height: 36px;
      background:
        radial-gradient(18px 10px at 10% 50%, rgba(255,255,255,0.12), transparent 60%),
        radial-gradient(18px 10px at 30% 50%, rgba(255,255,255,0.10), transparent 60%),
        radial-gradient(18px 10px at 50% 50%, rgba(255,255,255,0.12), transparent 60%),
        radial-gradient(18px 10px at 70% 50%, rgba(255,255,255,0.10), transparent 60%),
        radial-gradient(18px 10px at 90% 50%, rgba(255,255,255,0.12), transparent 60%);
      filter: blur(0.2px);
      animation: waveMove 5s linear infinite;
      opacity: .9;
    }
    @keyframes waveMove{
      from{ transform: translateX(0); }
      to{ transform: translateX(-10%); }
    }

    .song-body{ padding: 14px; display:flex; flex-direction:column; gap: 8px; }
    .song-title{ font-weight: 800; font-size: 1.06rem; letter-spacing: .2px; }
    .song-meta{ display:flex; gap:10px; align-items:center; flex-wrap: wrap; color: var(--muted); font-size: .86rem; }
    .song-badge{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: .82rem;
      color: rgba(255,255,255,0.88);
    }
    .song-req-author{ opacity:.9; }
    .song-req{
      color: rgba(255,255,255,0.78);
      font-size: .9rem;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* ===== Player (tu custom) ===== */
    .song-player{ margin-top: 8px; }
    .song-player--noaudio{
      margin-top: 8px;
      padding: 10px 12px;
      border: 1px dashed rgba(255,255,255,0.18);
      border-radius: 14px;
      color: var(--muted);
      font-size: .9rem;
      background: rgba(0,0,0,0.35);
    }
    .bm-player{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.35);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .bm-play-btn{
      width: 40px; height: 40px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      position: relative;
    }
    .bm-play-icon{
      width: 0; height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-left: 12px solid rgba(255,255,255,0.9);
      position:absolute;
    }
    .bm-pause-icon{
      width: 12px; height: 16px;
      position:absolute;
      display:none;
    }
    .bm-pause-icon::before,
    .bm-pause-icon::after{
      content:"";
      position:absolute;
      top:0; width:4px; height:16px;
      background: rgba(255,255,255,0.9);
      border-radius:2px;
    }
    .bm-pause-icon::before{ left:0; }
    .bm-pause-icon::after{ right:0; }

    .bm-player.is-playing .bm-play-icon{ display:none; }
    .bm-player.is-playing .bm-pause-icon{ display:block; }

    .bm-player-main{ flex:1; min-width: 0; }
    .bm-time-row{
      display:flex; justify-content:space-between; align-items:center;
      font-size: .82rem; color: var(--muted);
      margin-bottom: 6px;
    }
    .bm-timeline{
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      overflow:hidden;
      cursor:pointer;
      position: relative;
    }
    .bm-timeline-progress{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,42,166,0.9), rgba(122,44,255,0.9));
    }

    /* ===== Votos + Ver m√°s ===== */
    .song-votes{
      display:flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .vote-btn{
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.9);
      border-radius: 999px;
      padding: 8px 10px;
      cursor:pointer;
      font: inherit;
      font-size: .9rem;
      display:inline-flex;
      gap: 8px;
      align-items:center;
    }
    .vote-btn.voted{
      border-color: rgba(255,42,166,0.45);
      box-shadow: 0 0 0 1px rgba(122,44,255,0.25) inset;
    }
    .songs-vote-hint{
      margin-top: 8px;
      color: var(--muted);
      font-size: .85rem;
    }
    .song-actions{
      display:flex;
      justify-content:flex-end;
      margin-top: 8px;
    }
    .song-more-btn{
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.9);
      border-radius: 999px;
      padding: 8px 12px;
      cursor:pointer;
      font: inherit;
      font-size: .86rem;
    }

    /* ===== Mini player global (tu icon system) ===== */
    .mini-player{
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.58);
      border-radius: 18px;
      padding: 10px 12px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.45);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      z-index: 60;
    }
    .mini-player-main{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      min-width:0;
    }
    .mini-player-left{
      display:flex; gap:10px; align-items:center; min-width:0;
    }
    .mini-player-cover{
      width: 44px; height: 44px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background:
        radial-gradient(26px 26px at 30% 30%, rgba(122,44,255,0.75), transparent 60%),
        radial-gradient(28px 28px at 70% 30%, rgba(255,42,166,0.55), transparent 60%),
        rgba(255,255,255,0.05);
      flex: 0 0 auto;
    }
    .mini-player-text{ min-width:0; }
    .mini-player-title{
      font-weight: 800;
      font-size: .95rem;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 52vw;
    }
    .mini-player-artist{
      color: rgba(255,255,255,0.65);
      font-size: .84rem;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 52vw;
    }
    .mini-player-controls{
      display:flex; gap:8px; align-items:center;
    }
    .mini-btn{
      width: 40px; height: 40px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.04);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      position: relative;
    }
    .icon-play, .icon-pause, .icon-skip{
      position:absolute;
      display:inline-block;
    }
    .icon-play{
      width:0; height:0;
      border-top: 7px solid transparent;
      border-bottom: 7px solid transparent;
      border-left: 11px solid rgba(255,255,255,0.9);
    }
    .icon-pause{
      width: 12px; height: 16px;
      display:none;
    }
    .icon-pause::before,
    .icon-pause::after{
      content:"";
      position:absolute;
      top:0;
      width:4px;
      height:16px;
      background: rgba(255,255,255,0.9);
      border-radius:2px;
    }
    .icon-pause::before{ left:0; }
    .icon-pause::after{ right:0; }

    .mini-btn-play.is-playing .icon-play{ display:none; }
    .mini-btn-play.is-playing .icon-pause{ display:inline-block; }

    .icon-skip{
      width: 0; height: 0;
      border-top: 7px solid transparent;
      border-bottom: 7px solid transparent;
      border-left: 10px solid rgba(255,255,255,0.9);
      transform: translateX(0);
    }
    .icon-skip-next::after{
      content:"";
      position:absolute;
      right:-6px;
      top:-7px;
      width:2px; height:14px;
      background: rgba(255,255,255,0.9);
      border-radius:2px;
    }
    .icon-skip-prev{
      transform: rotate(180deg);
    }
    .icon-skip-prev::after{
      content:"";
      position:absolute;
      right:-6px;
      top:-7px;
      width:2px; height:14px;
      background: rgba(255,255,255,0.9);
      border-radius:2px;
    }

    .mini-player-progress{
      display:flex; align-items:center; gap:10px;
    }
    .mini-time{ color: rgba(255,255,255,0.65); font-size:.82rem; width: 44px; text-align:center; }
    #mini-progress-bar{ width:100%; }

    /* ====== ‚úÖ Modal de comentarios (nuevo) ====== */
    .song-comments-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 80;
    }
    .song-comments-backdrop.open{ display:flex; }

    .song-comments-modal{
      width: min(920px, 100%);
      max-height: min(82vh, 760px);
      overflow:auto;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.60);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 18px 70px rgba(0,0,0,0.55);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .song-comments-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .song-comments-kicker{ font-size:.85rem; color: rgba(255,255,255,0.65); text-transform: uppercase; letter-spacing: .12em; }
    .song-comments-title{ font-size: 1.2rem; font-weight: 900; margin-top: 6px; }
    .song-comments-sub{ color: rgba(255,255,255,0.65); font-size: .9rem; margin-top: 6px; }

    .divider{ height:1px; background: rgba(255,255,255,0.08); margin: 14px 0; }
    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.35);
      border-radius: 14px;
      padding: 12px;
      min-width: 0;
    }
    .small{ font-size:.82rem; color: rgba(255,255,255,0.65); margin-top:4px; }
    .textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(0,0,0,0.75);
      color: rgba(255,255,255,0.92);
      padding: 10px 12px;
      font: inherit;
      resize: vertical;
      min-height: 90px;
    }
    .btn-sm{ padding: 6px 12px; font-size: 0.78rem; }

    .comment-replies{
      margin-top:10px;
      padding-left: 14px;
      border-left: 2px solid rgba(255,255,255,0.08);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .comment-replybox{ margin-top:10px; display:none; }
    .comment-replybox.open{ display:block; }

    /* ‚úÖ Fix visual (ya lo ten√≠as): iconos del mini player blancos */
    .mini-btn .icon-play,
    .mini-btn .icon-pause::before,
    .mini-btn .icon-pause::after,
    .mini-btn .icon-skip {
      border-left-color: rgba(255,255,255,0.9) !important;
      background: rgba(255,255,255,0.9) !important;
    }
  </style>
</head>

<body>
  <div class="songs-page">
    <header class="site-header">
      <div class="pill"><strong>BeefMusic</strong> ¬∑ Canciones</div>
      <a class="pill" href="index.html">‚Üê Inicio</a>
    </header>

    <section class="songs-hero">
      <div class="songs-hero-top">
        <div>
          <div class="section-kicker">Colecci√≥n BeefMusic</div>
          <h1 class="section-title">Canciones publicadas</h1>
          <div class="songs-sub">Busca, filtra y vota. Usa <strong>Ver m√°s</strong> para abrir comentarios del tema.</div>
        </div>
        <div class="songs-count" id="songs-count"></div>
      </div>

      <div class="songs-tools">
        <input id="songs-search" class="songs-search" placeholder="Busca t√≠tulo, autor, estilo o descripci√≥n..." />

        <div class="songs-pills" id="songs-filter-pills">
          <button class="songs-filter-btn active" data-style="">Todos</button>
          <button class="songs-filter-btn" data-style="trap">Trap</button>
          <button class="songs-filter-btn" data-style="reggaeton">Reggaet√≥n</button>
          <button class="songs-filter-btn" data-style="dembow">Dembow</button>
        </div>

        <div class="songs-pills" id="songs-sort-pills">
          <button class="songs-filter-btn active" data-sort="recientes">Recientes</button>
          <button class="songs-filter-btn" data-sort="top">Top</button>
        </div>
      </div>
    </section>

    <section class="songs-grid" id="songs-grid"></section>
  </div>

  <!-- ‚úÖ MODAL COMENTARIOS -->
  <div class="song-comments-backdrop" id="song-comments-backdrop" aria-hidden="true">
    <div class="song-comments-modal" role="dialog" aria-modal="true" aria-labelledby="song-comments-title">
      <div class="song-comments-head">
        <div>
          <div class="song-comments-kicker">Comentarios</div>
          <div class="song-comments-title" id="song-comments-title">‚Äî</div>
          <div class="song-comments-sub" id="song-comments-sub">‚Äî</div>
        </div>
        <button class="btn btn-ghost btn-sm" id="song-comments-close">Cerrar</button>
      </div>

      <div class="divider"></div>

      <textarea class="textarea" id="song-comment-input" placeholder="Escribe un comentario (m√°x 800)‚Ä¶" maxlength="800"></textarea>
      <div class="songs-tools" style="margin-top:10px;">
        <div class="songs-pills" style="gap:10px;">
          <button class="btn btn-primary btn-sm" id="song-comment-send">Comentar</button>
          <button class="btn btn-ghost btn-sm" id="song-comments-reload">Recargar</button>
          <span style="color:rgba(255,255,255,0.65); font-size:.9rem;" id="song-comment-status">‚Äî</span>
        </div>
      </div>

      <div class="divider"></div>

      <div id="song-comments-root" class="list">
        <div style="color:rgba(255,255,255,0.65);">Selecciona una canci√≥n para ver comentarios.</div>
      </div>
    </div>
  </div>

  <!-- MINI PLAYER -->
  <div id="mini-player" class="mini-player">
    <div class="mini-player-main">
      <div class="mini-player-left">
        <div id="mini-player-cover" class="mini-player-cover"></div>
        <div class="mini-player-text">
          <div id="mini-player-title" class="mini-player-title">Nada reproduci√©ndose</div>
          <div id="mini-player-artist" class="mini-player-artist">Selecciona una canci√≥n</div>
        </div>
      </div>

      <div class="mini-player-controls">
        <button id="mini-prev-btn" class="mini-btn mini-btn-skip" aria-label="Anterior">
          <span class="icon-skip icon-skip-prev" aria-hidden="true"></span>
        </button>

        <button id="mini-play-pause-btn" class="mini-btn mini-btn-play" aria-label="Reproducir / Pausar">
          <span class="icon-play" aria-hidden="true"></span>
          <span class="icon-pause" aria-hidden="true"></span>
        </button>

        <button id="mini-next-btn" class="mini-btn mini-btn-skip" aria-label="Siguiente">
          <span class="icon-skip icon-skip-next" aria-hidden="true"></span>
        </button>
      </div>
    </div>

    <div class="mini-player-progress">
      <span id="mini-current-time" class="mini-time">0:00</span>
      <input type="range" id="mini-progress-bar" min="0" value="0" step="1" />
      <span id="mini-duration" class="mini-time">0:00</span>
    </div>
  </div>

  <script>
    const API_URL = "https://beefmusic-backend.onrender.com";

    const grid = document.getElementById("songs-grid");
    const countEl = document.getElementById("songs-count");
    const searchInput = document.getElementById("songs-search");

    const filterPills = document.querySelectorAll("#songs-filter-pills .songs-filter-btn");
    const sortPills = document.querySelectorAll("#songs-sort-pills .songs-filter-btn");

    let allSongs = [];
    let currentStyleFilter = "";
    let currentSortMode = "recientes";

    // === MINI PLAYER GLOBAL ===
    const miniPlayer = document.getElementById("mini-player");
    const miniCover = document.getElementById("mini-player-cover");
    const miniTitle = document.getElementById("mini-player-title");
    const miniArtist = document.getElementById("mini-player-artist");
    const miniPlayPauseBtn = document.getElementById("mini-play-pause-btn");
    const miniPrevBtn = document.getElementById("mini-prev-btn");
    const miniNextBtn = document.getElementById("mini-next-btn");
    const miniProgressBar = document.getElementById("mini-progress-bar");
    const miniCurrentTime = document.getElementById("mini-current-time");
    const miniDuration = document.getElementById("mini-duration");

    let globalPlayers = []; // { audio, playerEl }
    let currentGlobalIndex = -1;
    let currentAudio = null;

    function setMiniPlaying(isPlaying) {
      miniPlayPauseBtn.classList.toggle("is-playing", isPlaying);
      miniPlayer.classList.toggle("is-active", isPlaying);
    }

    function formatTimeGlobal(sec) {
      if (!sec || isNaN(sec)) return "0:00";
      const total = Math.floor(sec);
      const minutes = Math.floor(total / 60);
      const seconds = total % 60;
      return minutes + ":" + String(seconds).padStart(2, "0");
    }

    function activarMiniPlayerDesdePlayer(playerEl, audioEl) {
      currentAudio = audioEl;
      currentGlobalIndex = globalPlayers.findIndex((p) => p.audio === audioEl);

      const title = playerEl.getAttribute("data-title") || "Tema sin t√≠tulo";
      const artist = playerEl.getAttribute("data-artist") || "@an√≥nimo";

      miniTitle.textContent = title;
      miniArtist.textContent = artist;

      const duration = audioEl.duration || 0;
      miniCurrentTime.textContent = formatTimeGlobal(audioEl.currentTime || 0);
      miniDuration.textContent = formatTimeGlobal(duration);
      miniProgressBar.max = duration || 0;
      miniProgressBar.value = audioEl.currentTime || 0;

      setMiniPlaying(!audioEl.paused);
    }

    function reproducirPorIndice(index) {
      if (!globalPlayers.length) return;
      if (index < 0) index = 0;
      if (index >= globalPlayers.length) index = 0;

      const { audio, playerEl } = globalPlayers[index];

      globalPlayers.forEach(({ audio: a, playerEl: p }) => {
        if (a !== audio) {
          a.pause();
          p.classList.remove("is-playing");
        }
      });

      audio.play();
      playerEl.classList.add("is-playing");
      activarMiniPlayerDesdePlayer(playerEl, audio);
      setMiniPlaying(true);
    }

    miniPlayPauseBtn.addEventListener("click", () => {
      if (!currentAudio) {
        if (globalPlayers.length > 0) reproducirPorIndice(0);
        return;
      }

      if (currentAudio.paused) {
        currentAudio.play();
        setMiniPlaying(true);
        const currentPlayer = globalPlayers[currentGlobalIndex]?.playerEl;
        if (currentPlayer) currentPlayer.classList.add("is-playing");
      } else {
        currentAudio.pause();
        setMiniPlaying(false);
        const currentPlayer = globalPlayers[currentGlobalIndex]?.playerEl;
        if (currentPlayer) currentPlayer.classList.remove("is-playing");
      }
    });

    miniNextBtn.addEventListener("click", () => {
      if (!globalPlayers.length) return;
      if (currentGlobalIndex === -1) { reproducirPorIndice(0); return; }
      let nextIndex = currentGlobalIndex + 1;
      if (nextIndex >= globalPlayers.length) nextIndex = 0;
      reproducirPorIndice(nextIndex);
    });

    miniPrevBtn.addEventListener("click", () => {
      if (!globalPlayers.length) return;
      if (currentGlobalIndex === -1) { reproducirPorIndice(0); return; }
      let prevIndex = currentGlobalIndex - 1;
      if (prevIndex < 0) prevIndex = globalPlayers.length - 1;
      reproducirPorIndice(prevIndex);
    });

    miniProgressBar.addEventListener("input", () => {
      if (!currentAudio || !currentAudio.duration) return;
      currentAudio.currentTime = miniProgressBar.value;
    });

    // ===== Comentarios (modal) =====
    const commentsBackdrop = document.getElementById("song-comments-backdrop");
    const commentsCloseBtn = document.getElementById("song-comments-close");
    const commentsTitle = document.getElementById("song-comments-title");
    const commentsSub = document.getElementById("song-comments-sub");
    const commentsRoot = document.getElementById("song-comments-root");
    const commentInput = document.getElementById("song-comment-input");
    const commentSendBtn = document.getElementById("song-comment-send");
    const commentsReloadBtn = document.getElementById("song-comments-reload");
    const commentStatus = document.getElementById("song-comment-status");

    let currentCommentsSongId = null;

    function getToken(){ return localStorage.getItem("beefmusic_user_token") || ""; }

    async function apiFetch(path, { method="GET", body=null, auth=false } = {}) {
      const headers = { "Content-Type": "application/json" };
      if (auth) {
        const t = getToken();
        if (t) headers.Authorization = `Bearer ${t}`;
      }
      const res = await fetch(API_URL + path, {
        method,
        headers,
        body: body ? JSON.stringify(body) : undefined,
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || "Error de petici√≥n");
      return data;
    }

    function escapeHtml(s){
      const div = document.createElement("div");
      div.textContent = s ?? "";
      return div.innerHTML;
    }
    function formatDate(iso){
      try { return new Date(iso).toLocaleString(); } catch { return ""; }
    }
    function setCommentStatus(msg){ commentStatus.textContent = msg; }

    function renderCommentNode(node){
      const username = node.user?.username || node.username || "unknown";
      const replies = (node.replies || []).map(r => renderCommentNode(r)).join("");

      return `
        <div class="item comment-item" data-comment-id="${node.id}">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap;">
            <div>
              <div><strong>@${escapeHtml(username)}</strong></div>
              <div class="small">${formatDate(node.createdAt || node.created_at)}</div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-ghost btn-sm" data-action="reply">Responder</button>
              <button class="btn btn-ghost btn-sm" data-action="report">Reportar</button>
            </div>
          </div>

          <div style="margin-top:8px; white-space:pre-wrap; word-break:break-word;">${escapeHtml(node.body)}</div>

          <div class="comment-replybox" data-replybox>
            <textarea class="textarea" rows="2" maxlength="800" placeholder="Responder (m√°x 800)‚Ä¶"></textarea>
            <div style="display:flex; gap:10px; margin-top:8px; flex-wrap:wrap;">
              <button class="btn btn-primary btn-sm" data-action="send-reply">Enviar</button>
              <button class="btn btn-ghost btn-sm" data-action="cancel-reply">Cancelar</button>
            </div>
          </div>

          ${replies ? `<div class="comment-replies">${replies}</div>` : ""}
        </div>
      `;
    }

    async function loadCommentsTree(){
      const songId = currentCommentsSongId;
      if (!songId) return;

      setCommentStatus("Cargando comentarios‚Ä¶");
      commentsRoot.innerHTML = `<div style="color:rgba(255,255,255,0.65);">Cargando‚Ä¶</div>`;

      try{
        const data = await apiFetch(`/api/canciones/${songId}/comments-tree?limit=50&offset=0&maxTotal=1200`);
        const items = data.items || [];
        commentsRoot.innerHTML = items.length
          ? items.map(n => renderCommentNode(n)).join("")
          : `<div style="color:rgba(255,255,255,0.65);">A√∫n no hay comentarios.</div>`;
        setCommentStatus("Listo.");
      } catch(e){
        commentsRoot.innerHTML = `<div style="color:rgba(255,255,255,0.65);">‚ùå ${escapeHtml(e.message)}</div>`;
        setCommentStatus("Error.");
      }
    }

    async function sendRootComment(){
      const songId = currentCommentsSongId;
      if (!songId) return;
      if (!getToken()) return alert("Inicia sesi√≥n para comentar.");

      const text = (commentInput.value || "").trim();
      if (!text) return;

      setCommentStatus("Enviando comentario‚Ä¶");
      try{
        await apiFetch(`/api/canciones/${songId}/comments`, {
          method:"POST",
          body:{ body: text, parentId: null },
          auth:true
        });
        commentInput.value = "";
        await loadCommentsTree();
      } catch(e){
        setCommentStatus("‚ùå " + e.message);
      }
    }

    async function sendReply(commentId, textarea){
      const songId = currentCommentsSongId;
      if (!songId) return;
      if (!getToken()) return alert("Inicia sesi√≥n para responder.");

      const text = (textarea.value || "").trim();
      if (!text) return;

      setCommentStatus("Enviando respuesta‚Ä¶");
      await apiFetch(`/api/canciones/${songId}/comments`, {
        method:"POST",
        body:{ body: text, parentId: commentId },
        auth:true
      });
      await loadCommentsTree();
    }

    async function reportComment(commentId){
      if (!getToken()) return alert("Inicia sesi√≥n para reportar.");
      const reason = prompt("Motivo del reporte (m√°x 500):");
      if (!reason) return;

      setCommentStatus("Enviando reporte‚Ä¶");
      await apiFetch(`/api/report/content`, {
        method:"POST",
        body:{ targetType:"comment", targetId: commentId, reason: reason.slice(0,500) },
        auth:true
      });
      setCommentStatus("Reporte enviado ‚úÖ");
      setTimeout(() => setCommentStatus("Listo."), 1200);
    }

    function openCommentsForSong(songId){
      currentCommentsSongId = String(songId);

      const song = allSongs.find(s => String(s.id) === String(songId));
      const titulo = song?.titulo || song?.title || "Tema";
      const autor  = song?.autor || song?.requester || song?.nick || "@an√≥nimo";
      const estilo = song?.estilo || song?.style || "‚Äî";

      commentsTitle.textContent = titulo;
      commentsSub.textContent = `${autor} ¬∑ ${estilo} ¬∑ ID ${songId}`;

      commentsBackdrop.classList.add("open");
      commentsBackdrop.setAttribute("aria-hidden", "false");

      // poner ?song= en URL sin recargar
      const url = new URL(location.href);
      url.searchParams.set("song", String(songId));
      history.replaceState({}, "", url.toString());

      loadCommentsTree();
    }

    function closeComments(){
      commentsBackdrop.classList.remove("open");
      commentsBackdrop.setAttribute("aria-hidden", "true");
      currentCommentsSongId = null;

      // quitar ?song= de URL sin recargar
      const url = new URL(location.href);
      url.searchParams.delete("song");
      history.replaceState({}, "", url.toString());
    }

    commentsCloseBtn.addEventListener("click", closeComments);
    commentsBackdrop.addEventListener("click", (e) => {
      if (e.target === commentsBackdrop) closeComments();
    });
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && commentsBackdrop.classList.contains("open")) closeComments();
    });

    commentSendBtn.addEventListener("click", sendRootComment);
    commentsReloadBtn.addEventListener("click", loadCommentsTree);

    commentsRoot.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;

      const item = btn.closest(".comment-item");
      const commentId = item?.dataset?.commentId;
      if (!commentId) return;

      const action = btn.dataset.action;

      if (action === "reply"){
        const box = item.querySelector("[data-replybox]");
        if (box) box.classList.toggle("open");
        return;
      }
      if (action === "cancel-reply"){
        const box = item.querySelector("[data-replybox]");
        if (box) box.classList.remove("open");
        return;
      }
      if (action === "send-reply"){
        const textarea = item.querySelector("[data-replybox] textarea");
        await sendReply(commentId, textarea);
        return;
      }
      if (action === "report"){
        await reportComment(commentId);
        return;
      }
    });

    // ===== P√°gina canciones =====
    function crearCardCancion(song) {
      const titulo = song.titulo || song.title || "Tema sin t√≠tulo";
      const estilo = song.estilo || song.style || "Sin g√©nero";
      const duracion = song.duracion || song.duration || "";
      const descripcion = song.descripcion || song.descripcion_peticion || song.description || "";
      const autor = song.autor || song.requester || song.nick || "@an√≥nimo";
      const estado = song.estado || "publicada";
      const urlAudio = song.url_audio || song.audio_url || "";

      const likes = song.likes ?? 0;
      const dislikes = song.dislikes ?? 0;
      const userVote = song.userVote || song.votoUsuario || "";

      return `
        <article class="song-card">
          <div class="song-thumb">
            <div class="song-wave"></div>
          </div>

          <div class="song-body">
            <div class="song-title">${titulo}</div>

            <div class="song-meta">
              <span class="song-badge">${estilo}</span>
              <span class="song-req-author">${autor}</span>
              ${duracion ? `<span>${duracion}</span>` : ""}
            </div>

            ${descripcion ? `<div class="song-req">${descripcion}</div>` : ""}

            <div class="song-meta" style="margin-top:6px;">
              <span class="song-badge">${estado}</span>
            </div>

            ${urlAudio ? `
              <div class="song-player">
                <div class="bm-player"
                     data-title="${titulo}"
                     data-artist="${autor}"
                     data-style="${estilo}">
                  <audio preload="none" class="bm-audio">
                    <source src="${urlAudio}" type="audio/mpeg" />
                    Tu navegador no soporta audio HTML5.
                  </audio>

                  <button class="bm-play-btn" type="button" aria-label="Reproducir / Pausar">
                    <span class="bm-play-icon" aria-hidden="true"></span>
                    <span class="bm-pause-icon" aria-hidden="true"></span>
                  </button>

                  <div class="bm-player-main">
                    <div class="bm-time-row">
                      <span class="bm-time bm-current">0:00</span>
                      <span class="bm-time bm-duration">0:00</span>
                    </div>
                    <div class="bm-timeline">
                      <div class="bm-timeline-progress"></div>
                    </div>
                  </div>
                </div>
              </div>
            ` : `
              <div class="song-player song-player--noaudio">
                El audio de este tema todav√≠a no est√° disponible.
              </div>
            `}

            <!-- VOTOS -->
            <div class="song-votes"
                 data-id="${song.id}"
                 data-user-vote="${userVote}">
              <button class="vote-btn like ${userVote === "like" ? "voted" : ""}" data-type="like">
                üëç <span class="vote-count">${likes}</span>
              </button>
              <button class="vote-btn dislike ${userVote === "dislike" ? "voted" : ""}" data-type="dislike">
                üëé <span class="vote-count">${dislikes}</span>
              </button>
            </div>

            <div class="song-actions">
              <button class="song-more-btn" type="button" data-action="more" data-id="${song.id}">Ver m√°s</button>
            </div>

            <div class="songs-vote-hint">
              Likes totales: ${likes} ¬∑ Dislikes totales: ${dislikes}
            </div>
          </div>
        </article>
      `;
    }

    function renderSongs(list) {
      if (currentAudio) { try { currentAudio.pause(); } catch(e){} }
      currentAudio = null;
      currentGlobalIndex = -1;

      if (miniTitle) {
        miniTitle.textContent = "Nada reproduci√©ndose";
        miniArtist.textContent = "Selecciona una canci√≥n";
        miniCurrentTime.textContent = "0:00";
        miniDuration.textContent = "0:00";
        miniProgressBar.value = 0;
        miniProgressBar.max = 0;
        setMiniPlaying(false);
      }

      if (!list || list.length === 0) {
        grid.innerHTML = `
          <div class="song-card" style="grid-column:1/-1;">
            <div class="song-body" style="color:rgba(255,255,255,0.65);">
              Todav√≠a no hay canciones publicadas. Cuando las subas desde tu backend, se ver√°n aqu√≠.
            </div>
          </div>
        `;
        countEl.textContent = "";
        return;
      }

      grid.innerHTML = list.map(crearCardCancion).join("");
      countEl.textContent = list.length + " canciones";
      inicializarReproductores();
    }

    function aplicarFiltros() {
      const text = (searchInput.value || "").toLowerCase().trim();
      const estiloFiltro = (currentStyleFilter || "").toLowerCase();

      const filtradas = allSongs.filter((song) => {
        const titulo = (song.titulo || song.title || "").toLowerCase();
        const autor = (song.autor || song.requester || song.nick || "").toLowerCase();
        const estilo = (song.estilo || song.style || "").toLowerCase();
        const descripcion = (song.descripcion || song.descripcion_peticion || song.description || "").toLowerCase();

        const pasaTexto =
          !text ||
          titulo.includes(text) ||
          autor.includes(text) ||
          estilo.includes(text) ||
          descripcion.includes(text);

        const pasaEstilo = !estiloFiltro || estilo.includes(estiloFiltro);

        return pasaTexto && pasaEstilo;
      });

      let listOrdenada = [...filtradas];

      if (currentSortMode === "top") {
        listOrdenada.sort((a, b) => {
          const likesA = a.likes ?? 0;
          const likesB = b.likes ?? 0;
          if (likesB !== likesA) return likesB - likesA;

          const dateA = a.created_at ? new Date(a.created_at) : 0;
          const dateB = b.created_at ? new Date(b.created_at) : 0;
          return dateB - dateA;
        });
      } else {
        listOrdenada.sort((a, b) => {
          const dateA = a.created_at ? new Date(a.created_at) : 0;
          const dateB = b.created_at ? new Date(b.created_at) : 0;
          return dateB - dateA;
        });
      }

      renderSongs(listOrdenada);
    }

    async function cargarCanciones() {
      grid.innerHTML = `
        <div class="song-card" style="grid-column:1/-1;">
          <div class="song-body" style="color:rgba(255,255,255,0.65);">
            Cargando canciones...
          </div>
        </div>
      `;
      countEl.textContent = "Cargando canciones...";

      try {
        const token = localStorage.getItem("beefmusic_user_token");

        const res = await fetch(API_URL + "/api/canciones", {
          headers: token ? { Authorization: "Bearer " + token } : {}
        });

        const data = await res.json();

        if (!res.ok) throw new Error(data.error || "Error al cargar canciones");
        if (!Array.isArray(data)) throw new Error("La API de canciones no devolvi√≥ una lista");

        allSongs = data;
        aplicarFiltros();

        // ‚úÖ auto-abrir comentarios si viene ?song=
        const params = new URLSearchParams(location.search);
        const song = (params.get("song") || "").trim();
        if (song) openCommentsForSong(song);

      } catch (err) {
        console.error(err);
        grid.innerHTML = `
          <div class="song-card" style="grid-column:1/-1;">
            <div class="song-body" style="color:rgba(255,255,255,0.65);">
              Error cargando las canciones desde el servidor.
              Cuando tengas listo el endpoint <code>/api/canciones</code>, se mostrar√°n aqu√≠.
            </div>
          </div>
        `;
        countEl.textContent = "";
      }
    }

    function inicializarReproductores(){
      globalPlayers = [];

      const players = Array.from(document.querySelectorAll(".bm-player"));
      players.forEach((playerEl) => {
        const audio = playerEl.querySelector(".bm-audio");
        const btn = playerEl.querySelector(".bm-play-btn");
        const timeCurrent = playerEl.querySelector(".bm-current");
        const timeDuration = playerEl.querySelector(".bm-duration");
        const timeline = playerEl.querySelector(".bm-timeline");
        const progress = playerEl.querySelector(".bm-timeline-progress");

        if (!audio || !btn) return;

        globalPlayers.push({ audio, playerEl });

        audio.addEventListener("loadedmetadata", () => {
          timeDuration.textContent = formatTimeGlobal(audio.duration);
        });

        audio.addEventListener("timeupdate", () => {
          timeCurrent.textContent = formatTimeGlobal(audio.currentTime);
          if (audio.duration) {
            const pct = (audio.currentTime / audio.duration) * 100;
            progress.style.width = pct + "%";
          }
          if (currentAudio === audio) {
            miniCurrentTime.textContent = formatTimeGlobal(audio.currentTime);
            miniProgressBar.value = audio.currentTime || 0;
          }
        });

        audio.addEventListener("ended", () => {
          playerEl.classList.remove("is-playing");
          if (currentAudio === audio) {
            setMiniPlaying(false);
          }
        });

        btn.addEventListener("click", () => {
          const isPlaying = !audio.paused;

          globalPlayers.forEach(({ audio: a, playerEl: p }) => {
            if (a !== audio) {
              a.pause();
              p.classList.remove("is-playing");
            }
          });

          if (isPlaying) {
            audio.pause();
            playerEl.classList.remove("is-playing");
            setMiniPlaying(false);
          } else {
            audio.play();
            playerEl.classList.add("is-playing");
            activarMiniPlayerDesdePlayer(playerEl, audio);
            setMiniPlaying(true);
          }
        });

        timeline.addEventListener("click", (e) => {
          if (!audio.duration) return;
          const rect = timeline.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const pct = Math.min(1, Math.max(0, x / rect.width));
          audio.currentTime = pct * audio.duration;
        });
      });
    }

    // Pills: filtro estilo
    filterPills.forEach((btn) => {
      btn.addEventListener("click", () => {
        filterPills.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentStyleFilter = btn.getAttribute("data-style") || "";
        aplicarFiltros();
      });
    });

    // Pills: sort
    sortPills.forEach((btn) => {
      btn.addEventListener("click", () => {
        sortPills.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentSortMode = btn.getAttribute("data-sort") || "recientes";
        aplicarFiltros();
      });
    });

    // Search
    searchInput.addEventListener("input", aplicarFiltros);

    // Clicks (votos + ver m√°s)
    grid.addEventListener("click", async (e) => {
      // ‚úÖ Ver m√°s
      const moreBtn = e.target.closest("button[data-action='more']");
      if (moreBtn){
        const id = moreBtn.getAttribute("data-id");
        if (id) openCommentsForSong(id);
        return;
      }

      // Votar
      const btn = e.target.closest("button.vote-btn");
      if (!btn) return;

      const votesWrapper = btn.closest(".song-votes");
      if (!votesWrapper) return;

      const token = localStorage.getItem("beefmusic_user_token");
      if (!token) {
        alert("Inicia sesi√≥n para votar.");
        return;
      }

      const songId = votesWrapper.getAttribute("data-id");
      const tipo = btn.getAttribute("data-type"); // 'like' o 'dislike'

      btn.disabled = true;

      try {
        const res = await fetch(API_URL + "/api/canciones/" + songId + "/vote", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({ tipo }),
        });

        const json = await res.json();

        if (!res.ok) {
          console.error("Error votando:", json);
          alert(json.error || "No se pudo registrar el voto");
          btn.disabled = false;
          return;
        }

        const likeCountEl = votesWrapper.querySelector(".vote-btn.like .vote-count");
        const dislikeCountEl = votesWrapper.querySelector(".vote-btn.dislike .vote-count");

        if (likeCountEl && typeof json.likes === "number") likeCountEl.textContent = json.likes;
        if (dislikeCountEl && typeof json.dislikes === "number") dislikeCountEl.textContent = json.dislikes;

        const newUserVote = json.userVote ?? null;
        votesWrapper.setAttribute("data-user-vote", newUserVote || "");

        votesWrapper.querySelectorAll(".vote-btn").forEach((b) => {
          const bType = b.getAttribute("data-type");
          if (newUserVote && bType === newUserVote) b.classList.add("voted");
          else b.classList.remove("voted");
        });

        const hint = votesWrapper.parentElement.querySelector(".songs-vote-hint");
        if (hint) hint.textContent = `Likes totales: ${json.likes} ¬∑ Dislikes totales: ${json.dislikes}`;

        const songIndex = allSongs.findIndex((s) => String(s.id) === String(songId));
        if (songIndex !== -1) {
          allSongs[songIndex].likes = json.likes;
          allSongs[songIndex].dislikes = json.dislikes;
        }

        aplicarFiltros();
      } catch (err) {
        console.error(err);
        alert("Error de conexi√≥n al votar la canci√≥n.");
      } finally {
        btn.disabled = false;
      }
    });

    // Carga inicial
    cargarCanciones();
  </script>
</body>
</html>
